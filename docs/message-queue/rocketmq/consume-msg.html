<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.8" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.26" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://lament-z.com/docs/message-queue/rocketmq/consume-msg.html"><meta property="og:site_name" content="é²¸é±¼æ°”çƒ"><meta property="og:title" content="RocketMQ æºç åˆ†æ-æ¶ˆè´¹æ¶ˆæ¯"><meta property="og:description" content="RocketMQ æºç åˆ†æ-æ¶ˆè´¹æ¶ˆæ¯ RocketMQ é¢å‘çš„åœºæ™¯å¾ˆå¤šï¼Œä¸åŒåœºæ™¯å¯¹æ¶ˆæ¯é˜Ÿåˆ—çš„è¦æ±‚æ˜¯ä¸ä¸€æ ·çš„ï¼Œå°¤å…¶æ˜¯åœ¨æ¶ˆè´¹ç¯èŠ‚ã€‚ è¿˜æ˜¯è€æ ·å­ï¼Œå…ˆä»‹ç»ä¸€äº›å®ƒçš„åè¯/åŸºç¡€æ¦‚å¿µï¼Œç„¶åä»‹ç»æ¶ˆè´¹ç›¸å…³çš„åˆ†ç±»ï¼Œæœ€åè·Ÿç€æºç å»çœ‹ã€‚ åŸºç¡€æ¦‚å¿µ è¿™éƒ¨åˆ†å¯ä»¥ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œæœ‰å›¾ï¼Œå®˜æ–¹ 4.xã€‚ æ¶ˆè´¹æ¨¡å¼ æ³¨ æ³¨æ„è·Ÿåé¢çš„ æ¶ˆæ¯æ¨¡å¼ MessageModel è¿›è¡ŒåŒºåˆ†ã€‚ æ¨/æ‹‰..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2024-03-05T07:00:53.000Z"><meta property="article:author" content="lament-z"><meta property="article:modified_time" content="2024-03-05T07:00:53.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"RocketMQ æºç åˆ†æ-æ¶ˆè´¹æ¶ˆæ¯","image":[""],"dateModified":"2024-03-05T07:00:53.000Z","author":[{"@type":"Person","name":"lament-z","url":"https://lament-z.com"}]}</script><title>RocketMQ æºç åˆ†æ-æ¶ˆè´¹æ¶ˆæ¯ | é²¸é±¼æ°”çƒ</title><meta name="description" content="RocketMQ æºç åˆ†æ-æ¶ˆè´¹æ¶ˆæ¯ RocketMQ é¢å‘çš„åœºæ™¯å¾ˆå¤šï¼Œä¸åŒåœºæ™¯å¯¹æ¶ˆæ¯é˜Ÿåˆ—çš„è¦æ±‚æ˜¯ä¸ä¸€æ ·çš„ï¼Œå°¤å…¶æ˜¯åœ¨æ¶ˆè´¹ç¯èŠ‚ã€‚ è¿˜æ˜¯è€æ ·å­ï¼Œå…ˆä»‹ç»ä¸€äº›å®ƒçš„åè¯/åŸºç¡€æ¦‚å¿µï¼Œç„¶åä»‹ç»æ¶ˆè´¹ç›¸å…³çš„åˆ†ç±»ï¼Œæœ€åè·Ÿç€æºç å»çœ‹ã€‚ åŸºç¡€æ¦‚å¿µ è¿™éƒ¨åˆ†å¯ä»¥ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œæœ‰å›¾ï¼Œå®˜æ–¹ 4.xã€‚ æ¶ˆè´¹æ¨¡å¼ æ³¨ æ³¨æ„è·Ÿåé¢çš„ æ¶ˆæ¯æ¨¡å¼ MessageModel è¿›è¡ŒåŒºåˆ†ã€‚ æ¨/æ‹‰...">
    <link rel="preload" href="/assets/style-BdF5bOKf.css" as="style"><link rel="stylesheet" href="/assets/style-BdF5bOKf.css">
    <link rel="modulepreload" href="/assets/app-BwsoMA_K.js"><link rel="modulepreload" href="/assets/consume-msg.html-D0usrJMn.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    <link rel="prefetch" href="/assets/index.html-ByVlT5RN.js" as="script"><link rel="prefetch" href="/assets/index.html-D1hCOvo7.js" as="script"><link rel="prefetch" href="/assets/debug-log.html-DrZ4rMkZ.js" as="script"><link rel="prefetch" href="/assets/update-list.html-D0YQI-ei.js" as="script"><link rel="prefetch" href="/assets/index.html-CGs5sUuk.js" as="script"><link rel="prefetch" href="/assets/index.html-D09vUJWF.js" as="script"><link rel="prefetch" href="/assets/index.html-QmKuri3c.js" as="script"><link rel="prefetch" href="/assets/index.html-Dv-AigPz.js" as="script"><link rel="prefetch" href="/assets/ms.html-KjGOmQWC.js" as="script"><link rel="prefetch" href="/assets/01-intro.html-D-6XABav.js" as="script"><link rel="prefetch" href="/assets/index.html-DA6BhI5B.js" as="script"><link rel="prefetch" href="/assets/index.html-DH33YOeJ.js" as="script"><link rel="prefetch" href="/assets/broker.html-gXN-26KC.js" as="script"><link rel="prefetch" href="/assets/ha.html-CNDfiV1i.js" as="script"><link rel="prefetch" href="/assets/intro.html-BKUTxXEI.js" as="script"><link rel="prefetch" href="/assets/namesrv.html-CYFxS8lC.js" as="script"><link rel="prefetch" href="/assets/send-msg.html-DbpFoNVc.js" as="script"><link rel="prefetch" href="/assets/store.html-CWpxoLu-.js" as="script"><link rel="prefetch" href="/assets/404.html-DUvIYsHC.js" as="script"><link rel="prefetch" href="/assets/index.html-CC9PzPya.js" as="script"><link rel="prefetch" href="/assets/photoswipe.esm-SzV8tJDW.js" as="script"><link rel="prefetch" href="/assets/SearchResult-C6JmyH00.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><!--[--><a class="route-link vp-brand" href="/"><!----><!----><span class="vp-site-name">é²¸é±¼æ°”çƒ</span></a><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-center"><!--[--><!----><!--]--><!--[--><nav class="vp-nav-links"><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/" aria-label="é¦–é¡µ"><!---->é¦–é¡µ<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link active" href="/docs/" aria-label="Guide"><!---->Guide<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="Java"><span class="title"><!---->Java</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/docs/java/juc/" aria-label="JUC"><!---->JUC<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="æ•°æ®åº“"><span class="title"><!---->æ•°æ®åº“</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link" href="/docs/database/mysql/" aria-label="MySQL"><!---->MySQL<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button type="button" class="dropdown-title" aria-label="æ¶ˆæ¯é˜Ÿåˆ—"><span class="title"><!---->æ¶ˆæ¯é˜Ÿåˆ—</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a class="route-link nav-link active" href="/docs/message-queue/rocketmq/" aria-label="RocketMQ"><!---->RocketMQ<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/blog/" aria-label="åšå®¢"><!---->åšå®¢<!----></a></div><div class="nav-item hide-in-mobile"><a class="route-link nav-link" href="/blog/debug-log.html" aria-label="è°ƒè¯•è®°å½•"><!---->è°ƒè¯•è®°å½•<!----></a></div></nav><!--]--><!--[--><!----><!--]--></div><div class="vp-navbar-end"><!--[--><!----><!--]--><!--[--><!----><!----><div class="nav-item hide-in-mobile"><button type="button" id="appearance-switch"><svg xmlns="http://www.w3.org/2000/svg" class="icon auto-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="auto icon" style="display:none;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm0-840c-198.78 0-360 161.22-360 360 0 198.84 161.22 360 360 360s360-161.16 360-360c0-198.78-161.22-360-360-360zm0 660V212c165.72 0 300 134.34 300 300 0 165.72-134.28 300-300 300z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon dark-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="dark icon" style="display:none;"><path d="M524.8 938.667h-4.267a439.893 439.893 0 0 1-313.173-134.4 446.293 446.293 0 0 1-11.093-597.334A432.213 432.213 0 0 1 366.933 90.027a42.667 42.667 0 0 1 45.227 9.386 42.667 42.667 0 0 1 10.24 42.667 358.4 358.4 0 0 0 82.773 375.893 361.387 361.387 0 0 0 376.747 82.774 42.667 42.667 0 0 1 54.187 55.04 433.493 433.493 0 0 1-99.84 154.88 438.613 438.613 0 0 1-311.467 128z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon light-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="light icon" style="display:block;"><path d="M952 552h-80a40 40 0 0 1 0-80h80a40 40 0 0 1 0 80zM801.88 280.08a41 41 0 0 1-57.96-57.96l57.96-58a41.04 41.04 0 0 1 58 58l-58 57.96zM512 752a240 240 0 1 1 0-480 240 240 0 0 1 0 480zm0-560a40 40 0 0 1-40-40V72a40 40 0 0 1 80 0v80a40 40 0 0 1-40 40zm-289.88 88.08-58-57.96a41.04 41.04 0 0 1 58-58l57.96 58a41 41 0 0 1-57.96 57.96zM192 512a40 40 0 0 1-40 40H72a40 40 0 0 1 0-80h80a40 40 0 0 1 40 40zm30.12 231.92a41 41 0 0 1 57.96 57.96l-57.96 58a41.04 41.04 0 0 1-58-58l58-57.96zM512 832a40 40 0 0 1 40 40v80a40 40 0 0 1-80 0v-80a40 40 0 0 1 40-40zm289.88-88.08 58 57.96a41.04 41.04 0 0 1-58 58l-57.96-58a41 41 0 0 1 57.96-57.96z"></path></svg></button></div><!--[--><button type="button" class="search-pro-button" aria-label="æœç´¢"><svg xmlns="http://www.w3.org/2000/svg" class="icon search-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="search icon"><path d="M192 480a256 256 0 1 1 512 0 256 256 0 0 1-512 0m631.776 362.496-143.2-143.168A318.464 318.464 0 0 0 768 480c0-176.736-143.264-320-320-320S128 303.264 128 480s143.264 320 320 320a318.016 318.016 0 0 0 184.16-58.592l146.336 146.368c12.512 12.48 32.768 12.48 45.28 0 12.48-12.512 12.48-32.768 0-45.28"></path></svg><div class="search-pro-placeholder">æœç´¢</div><div class="search-pro-key-hints"><kbd class="search-pro-key">Ctrl</kbd><kbd class="search-pro-key">K</kbd></div></button><!--]--><!--]--><!--[--><!----><!--]--><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!--[--><!----><!--]--><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-heading clickable active"><!----><a class="route-link nav-link active vp-sidebar-title" href="/docs/message-queue/rocketmq/" aria-label="MQ"><!---->MQ<!----></a><!----></p><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><button class="vp-sidebar-heading clickable active" type="button"><!----><span class="vp-sidebar-title">RocketMQ æ–‡æ¡£ç›®å½•</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/message-queue/rocketmq/intro.html" aria-label="RocketMQ æºç åˆ†æ-æ¦‚è¿°"><!---->RocketMQ æºç åˆ†æ-æ¦‚è¿°<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/message-queue/rocketmq/send-msg.html" aria-label="RocketMQ æºç åˆ†æ-å‘é€æ¶ˆæ¯"><!---->RocketMQ æºç åˆ†æ-å‘é€æ¶ˆæ¯<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/message-queue/rocketmq/namesrv.html" aria-label="RocketMQ æºç åˆ†æ-NameSrv"><!---->RocketMQ æºç åˆ†æ-NameSrv<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/message-queue/rocketmq/broker.html" aria-label="RocketMQ æºç åˆ†æ-Broker"><!---->RocketMQ æºç åˆ†æ-Broker<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/message-queue/rocketmq/store.html" aria-label="RocketMQ æºç åˆ†æ-æ¶ˆæ¯å­˜å‚¨å’ŒæŒä¹…åŒ–"><!---->RocketMQ æºç åˆ†æ-æ¶ˆæ¯å­˜å‚¨å’ŒæŒä¹…åŒ–<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a class="route-link nav-link active vp-sidebar-link vp-sidebar-page active" href="/docs/message-queue/rocketmq/consume-msg.html" aria-label="RocketMQ æºç åˆ†æ-æ¶ˆè´¹æ¶ˆæ¯"><!---->RocketMQ æºç åˆ†æ-æ¶ˆè´¹æ¶ˆæ¯<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#åŸºç¡€æ¦‚å¿µ" aria-label="åŸºç¡€æ¦‚å¿µ"><!---->åŸºç¡€æ¦‚å¿µ<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#æ¶ˆè´¹æ¨¡å¼" aria-label="æ¶ˆè´¹æ¨¡å¼"><!---->æ¶ˆè´¹æ¨¡å¼<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#æ¶ˆè´¹è€…-consumer" aria-label="æ¶ˆè´¹è€… Consumer"><!---->æ¶ˆè´¹è€… Consumer<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#æ¶ˆè´¹ç»„-consumergroup" aria-label="æ¶ˆè´¹ç»„ ConsumerGroup"><!---->æ¶ˆè´¹ç»„ ConsumerGroup<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#messagemode-æ¶ˆæ¯æ¨¡å¼" aria-label="MessageMode æ¶ˆæ¯æ¨¡å¼"><!---->MessageMode æ¶ˆæ¯æ¨¡å¼<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#é›†ç¾¤æ¨¡å¼-è´Ÿè½½å‡è¡¡" aria-label="é›†ç¾¤æ¨¡å¼-è´Ÿè½½å‡è¡¡"><!---->é›†ç¾¤æ¨¡å¼-è´Ÿè½½å‡è¡¡<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#æ¶ˆè´¹ä½ç‚¹-consuming-point" aria-label="æ¶ˆè´¹ä½ç‚¹ (consuming point)"><!---->æ¶ˆè´¹ä½ç‚¹ (consuming point)<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#è®¢é˜…å…³ç³»-è®¢é˜…å…³ç³»ä¸€è‡´" aria-label="è®¢é˜…å…³ç³» &amp;&amp; è®¢é˜…å…³ç³»ä¸€è‡´"><!---->è®¢é˜…å…³ç³» &amp;&amp; è®¢é˜…å…³ç³»ä¸€è‡´<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#æºç åˆ†æ" aria-label="æºç åˆ†æ"><!---->æºç åˆ†æ<!----></a><ul class="vp-sidebar-sub-headers"><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#æ¶ˆè´¹ç«¯çš„å®ç°ç±»" aria-label="æ¶ˆè´¹ç«¯çš„å®ç°ç±»"><!---->æ¶ˆè´¹ç«¯çš„å®ç°ç±»<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#consumer-å¯åŠ¨æµç¨‹" aria-label="Consumer å¯åŠ¨æµç¨‹"><!---->Consumer å¯åŠ¨æµç¨‹<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#consumemessageservice" aria-label="ConsumeMessageService"><!---->ConsumeMessageService<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#pullmessageservice" aria-label="PullMessageService"><!---->PullMessageService<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#è´Ÿè½½å‡è¡¡" aria-label="è´Ÿè½½å‡è¡¡"><!---->è´Ÿè½½å‡è¡¡<!----></a><ul class="vp-sidebar-sub-headers"></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#æ¶ˆæ¯ç¡®è®¤" aria-label="æ¶ˆæ¯ç¡®è®¤"><!---->æ¶ˆæ¯ç¡®è®¤<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul></li><li class="vp-sidebar-sub-header"><a class="route-link nav-link vp-sidebar-link vp-heading" href="/docs/message-queue/rocketmq/consume-msg.html#æ€»ç»“" aria-label="æ€»ç»“"><!---->æ€»ç»“<!----></a><ul class="vp-sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a class="route-link nav-link vp-sidebar-link vp-sidebar-page" href="/docs/message-queue/rocketmq/ha.html" aria-label="RocketMQ æºç åˆ†æ-é«˜å¯ç”¨ HA"><!---->RocketMQ æºç åˆ†æ-é«˜å¯ç”¨ HA<!----></a><ul class="vp-sidebar-sub-headers"></ul><!--]--></li></ul></section></li></ul></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!--[--><!----><!--]--><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->RocketMQ æºç åˆ†æ-æ¶ˆè´¹æ¶ˆæ¯</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://lament-z.com" target="_blank" rel="noopener noreferrer">lament-z</a></span><span property="author" content="lament-z"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2024-03-01T15:08:50.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 22 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT22M"></span><!----><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><!--[--><!----><!--]--><div class="toc-header">æ­¤é¡µå†…å®¹<!----></div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#åŸºç¡€æ¦‚å¿µ">åŸºç¡€æ¦‚å¿µ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#æ¶ˆè´¹æ¨¡å¼">æ¶ˆè´¹æ¨¡å¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#æ¶ˆè´¹è€…-consumer">æ¶ˆè´¹è€… Consumer</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#æ¶ˆè´¹ç»„-consumergroup">æ¶ˆè´¹ç»„ ConsumerGroup</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#messagemode-æ¶ˆæ¯æ¨¡å¼">MessageMode æ¶ˆæ¯æ¨¡å¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#é›†ç¾¤æ¨¡å¼-è´Ÿè½½å‡è¡¡">é›†ç¾¤æ¨¡å¼-è´Ÿè½½å‡è¡¡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#æ¶ˆè´¹ä½ç‚¹-consuming-point">æ¶ˆè´¹ä½ç‚¹ (consuming point)</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#è®¢é˜…å…³ç³»-è®¢é˜…å…³ç³»ä¸€è‡´">è®¢é˜…å…³ç³» &amp;&amp; è®¢é˜…å…³ç³»ä¸€è‡´</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#æºç åˆ†æ">æºç åˆ†æ</a></li><li><ul class="toc-list"><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#æ¶ˆè´¹ç«¯çš„å®ç°ç±»">æ¶ˆè´¹ç«¯çš„å®ç°ç±»</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#consumer-å¯åŠ¨æµç¨‹">Consumer å¯åŠ¨æµç¨‹</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#consumemessageservice">ConsumeMessageService</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#pullmessageservice">PullMessageService</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#è´Ÿè½½å‡è¡¡">è´Ÿè½½å‡è¡¡</a></li><!----><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level3" href="/#æ¶ˆæ¯ç¡®è®¤">æ¶ˆæ¯ç¡®è®¤</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="toc-item"><a class="route-link toc-link level2" href="/#æ€»ç»“">æ€»ç»“</a></li><!----><!--]--></ul><div class="toc-marker" style="top:-1.7rem;"></div></div><!--[--><!----><!--]--></aside></div><!--[--><!----><!--]--><div class="theme-hope-content"><h1 id="rocketmq-æºç åˆ†æ-æ¶ˆè´¹æ¶ˆæ¯" tabindex="-1"><a class="header-anchor" href="#rocketmq-æºç åˆ†æ-æ¶ˆè´¹æ¶ˆæ¯"><span>RocketMQ æºç åˆ†æ-æ¶ˆè´¹æ¶ˆæ¯</span></a></h1><p>RocketMQ é¢å‘çš„åœºæ™¯å¾ˆå¤šï¼Œä¸åŒåœºæ™¯å¯¹æ¶ˆæ¯é˜Ÿåˆ—çš„è¦æ±‚æ˜¯ä¸ä¸€æ ·çš„ï¼Œå°¤å…¶æ˜¯åœ¨æ¶ˆè´¹ç¯èŠ‚ã€‚</p><p>è¿˜æ˜¯è€æ ·å­ï¼Œå…ˆä»‹ç»ä¸€äº›å®ƒçš„åè¯/åŸºç¡€æ¦‚å¿µï¼Œç„¶åä»‹ç»æ¶ˆè´¹ç›¸å…³çš„åˆ†ç±»ï¼Œæœ€åè·Ÿç€æºç å»çœ‹ã€‚</p><h2 id="åŸºç¡€æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#åŸºç¡€æ¦‚å¿µ"><span>åŸºç¡€æ¦‚å¿µ</span></a></h2><p>è¿™éƒ¨åˆ†å¯ä»¥ç›´æ¥çœ‹å®˜æ–¹æ–‡æ¡£ï¼Œæœ‰å›¾ï¼Œ<a href="https://rocketmq.apache.org/zh/docs/4.x/consumer/01concept2" target="_blank" rel="noopener noreferrer">å®˜æ–¹ 4.x<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚</p><h3 id="æ¶ˆè´¹æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#æ¶ˆè´¹æ¨¡å¼"><span>æ¶ˆè´¹æ¨¡å¼</span></a></h3><div class="hint-container note"><p class="hint-container-title">æ³¨</p><p>æ³¨æ„è·Ÿåé¢çš„ æ¶ˆæ¯æ¨¡å¼ MessageModel è¿›è¡ŒåŒºåˆ†ã€‚</p></div><p>æ¨/æ‹‰ä¸¤ç§æ¨¡å¼éƒ½æ”¯æŒï¼Œæœ¬è´¨ä¸Šå·®åˆ«ä¸å¤§ï¼Œä½ æŠŠ push çœ‹æˆè‡ªåŠ¨ pull å³å¯ã€‚</p><ul><li><p>push<br> åœ¨æ¶ˆæ¯é˜Ÿåˆ—è¯­å¢ƒä¸‹ï¼Œpush åº”è¯¥æ˜¯æœåŠ¡ç«¯è‡ªåŠ¨å‘ Consumer æ¨é€æ¶ˆæ¯ã€‚åœ¨ RocketMQ è¯­å¢ƒä¸‹å…¶å®å°±æ˜¯å‘¨æœŸæ€§çš„è‡ªåŠ¨ä» broker æ‹‰å–æ¶ˆæ¯å¹¶å­˜å…¥ Consumer æœ¬åœ°é˜Ÿåˆ—ï¼Œä¸æ­¤åŒæ—¶ Consumer ä¸æ–­çš„ä»æœ¬åœ°é˜Ÿåˆ—é‡Œå–å‡ºæ¶ˆæ¯è¿›è¡Œå¤„ç†ã€‚</p></li><li><p>pull<br> Consumer ä¸»åŠ¨ä»æœåŠ¡ç«¯çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ‹‰å–æ¶ˆæ¯ã€‚</p></li></ul><p>æ— è®ºå“ªç§æ¨¡å¼éƒ½è¦æ³¨æ„ï¼Œæ—¢è¦é¿å…æ¶ˆæ¯åœ¨æœ¬åœ°å †ç§¯ï¼ŒåŒæ—¶è¦æ³¨æ„æ¶ˆè´¹é—´éš”ä¸èƒ½å¤ªé•¿ã€‚</p><p>é™¤äº†æ¨æ‹‰ä¹‹å¤–ï¼Œåœ¨ Consumer æ¶ˆè´¹æ¶ˆæ¯è¿™ä¸ªè¡Œä¸ºè¿™ä¸€å±‚ï¼Œè¿˜æ”¯æŒé¡ºåºæ¶ˆè´¹å’Œå¹¶å‘æ¶ˆè´¹ã€‚</p><ul><li><p>é¡ºåºæ¶ˆè´¹ ConsumeMessageOrderly<br> é¡ºåºæ¶ˆè´¹æ˜¯åœ¨åŒä¸€ä¸ªé˜Ÿåˆ—ä¸Šæœ‰åºï¼Œå¹¶ä¸æ˜¯åœ¨ Topic ä¸‹å…¨å±€æœ‰åºï¼Œå› ä¸º Topic é€šå¸¸éƒ½ä¼šæœ‰å¥½å‡ ä¸ªé˜Ÿåˆ—ã€‚</p><p>ä½ å¯ä»¥é€šè¿‡è®¾ç½® Topic ä¸‹åªæœ‰ä¸€ä¸ªé˜Ÿåˆ—æ¥è¾¾æˆå…¨å±€æœ‰åºï¼Œç‰ºç‰²é˜Ÿåˆ—æœ¬èº«çš„é«˜å¯ç”¨ï¼Œä¼˜åŠ¿æ˜¯ä¸éœ€è¦åšé¢å¤–çš„å·¥ä½œï¼›ä¹Ÿå¯ä»¥ç›´æ¥ç»™æ¶ˆæ¯åŠ ä¸Šå…¨å±€è‡ªå¢çš„å”¯ä¸€IDçš„æ–¹å¼è‡ªè¡Œå®ç°å…¨å±€æœ‰åºï¼Œå°±æ˜¯å®ç°æ–¹æ¡ˆæ¯”è¾ƒéº»çƒ¦ï¼Œä¸è¿‡åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿé‡Œä½ æ€»èƒ½æ‰¾åˆ°å¾ˆå¤šç°æˆçš„åŠŸèƒ½æ‹¿æ¥å¤ç”¨ã€‚</p><p>é¡ºåºæ¶ˆè´¹ä»…é€‚ç”¨äºé›†ç¾¤æ¨¡å¼ã€‚</p></li><li><p>å¹¶å‘æ¶ˆè´¹<br> å°±æ˜¯ä»¥å¹¶å‘çš„æ–¹å¼æ¶ˆè´¹æ¶ˆæ¯ã€‚</p></li></ul><h3 id="æ¶ˆè´¹è€…-consumer" tabindex="-1"><a class="header-anchor" href="#æ¶ˆè´¹è€…-consumer"><span>æ¶ˆè´¹è€… Consumer</span></a></h3><p>å¯ä»¥ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ¶ˆè´¹æ¶ˆæ¯çš„ï¼Œéƒ½ç»Ÿä¸€çœ‹ä½œæ˜¯æ¶ˆè´¹è€…ã€‚ å¯¹äº Java è¯­å¢ƒï¼ŒRocketMQ æä¾›äº† <code>MQPushConsumer</code> å’Œ <code>MQPullConsumer</code> ä¸¤ä¸ªæ¥å£ä»¥åŠå¯¹åº”çš„å®ç°ç±»ï¼Œä»¥ä¾¿ç”¨æˆ·å¯ä»¥å¿«é€Ÿåˆ›å»º Consumerï¼Œäº¦æˆ–è€…æ˜¯è‡ªè¡Œå®ç°æ¶ˆè´¹å®¢æˆ·ç«¯ã€‚</p><p>PUSH æ¨¡å¼çš„é»˜è®¤å®ç°ç±»ï¼š<code>DefaultMQPushConsumer</code>ã€‚</p><p>PULL æ¨¡å¼çš„é»˜è®¤å®ç°ç±»ï¼š<code>DefaultLitePullConsumer</code>ï¼Œå¦ä¸€ä¸ªå·²å¼ƒç”¨ã€‚</p><h3 id="æ¶ˆè´¹ç»„-consumergroup" tabindex="-1"><a class="header-anchor" href="#æ¶ˆè´¹ç»„-consumergroup"><span>æ¶ˆè´¹ç»„ ConsumerGroup</span></a></h3><p>æ¶ˆè´¹ç»„ç”±è®¢é˜…ç›¸åŒ Topic çš„æ¶ˆè´¹è€…ç»„æˆã€‚ä¹Ÿå°±æ˜¯è¯´ ConsumerGroup å’Œ Topic ä¸€æ ·å¿…é¡»å”¯ä¸€ï¼Œè€Œä¸”è¦å’Œ Topic ä¸€ä¸€å¯¹åº”ï¼Œå‚è€ƒè®¢é˜…å…³ç³»ã€‚</p><h3 id="messagemode-æ¶ˆæ¯æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#messagemode-æ¶ˆæ¯æ¨¡å¼"><span>MessageMode æ¶ˆæ¯æ¨¡å¼</span></a></h3><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>æ¶ˆæ¯æ¨¡å¼ä¸ºéå®˜æ–¹è¯‘å</p></div><p>RocketMQ æä¾›äº†ä¸¤ç§ MessageModeï¼Œé›†ç¾¤æ¨¡å¼å’Œå¹¿æ’­æ¨¡å¼ã€‚</p><ul><li><p>é›†ç¾¤æ¨¡å¼ <code>MessageModel.CLUSTERING</code> ï¼š<br> é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œå¯¹ RocketMQ è€Œè¨€ï¼Œä»»æ„ä¸€æ¡æ¶ˆæ¯ï¼Œåªè¦è¢«æ¶ˆè´¹ç»„å†…ä»»æ„ Consumer æ¶ˆè´¹æˆåŠŸï¼Œè¯¥æ¶ˆæ¯å°±è¢«è§†ä¸ºå·²æ¶ˆè´¹ã€‚</p></li><li><p>å¹¿æ’­æ¨¡å¼ <code>MessageModel.BROADCASTING</code>ï¼š<br> å¹¿æ’­æ¨¡å¼ä¸‹ï¼Œå¯¹ RocketMQ è€Œè¨€ï¼Œä»»æ„ä¸€æ¡æ¶ˆæ¯ï¼Œéœ€è¦è¢«æ¶ˆè´¹ç»„å†…æ‰€æœ‰ Consumer è‡³å°‘æ¶ˆè´¹æˆåŠŸ 1 æ¬¡ï¼Œè¯¥æ¶ˆæ¯æ‰è¢«è§†ä¸ºå·²æ¶ˆè´¹ã€‚</p></li></ul><h3 id="é›†ç¾¤æ¨¡å¼-è´Ÿè½½å‡è¡¡" tabindex="-1"><a class="header-anchor" href="#é›†ç¾¤æ¨¡å¼-è´Ÿè½½å‡è¡¡"><span>é›†ç¾¤æ¨¡å¼-è´Ÿè½½å‡è¡¡</span></a></h3><p>é›†ç¾¤æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯æ¶ˆè´¹çš„æ–¹å¼ç±»ä¼¼äºâ€œè¯·æ±‚-&gt;ç½‘å…³-&gt;æœåŠ¡â€çš„æ–¹å¼ï¼Œæ‰€ä»¥åœ¨æ¶ˆæ¯è¢«æ¶ˆè´¹ä¹‹å‰å¯ä»¥åŠ ä¸€å±‚è´Ÿè½½å‡è¡¡æ¥åˆ†é…æ¶ˆæ¯ã€‚</p><p>ç›®å‰ RocketMQ æä¾›äº†å…­ç§åˆ†é…ç­–ç•¥ï¼Œé»˜è®¤ä¸ºï¼šAllocateMessageQueueAveragelyã€‚</p><h3 id="æ¶ˆè´¹ä½ç‚¹-consuming-point" tabindex="-1"><a class="header-anchor" href="#æ¶ˆè´¹ä½ç‚¹-consuming-point"><span>æ¶ˆè´¹ä½ç‚¹ (consuming point)</span></a></h3><div class="hint-container tip"><p class="hint-container-title">æç¤º</p><p>ä¸­è‹±éƒ½æ˜¯å®˜æ–¹åç§°</p></div><p>ç±»ä¼¼å‰å‡ ç¯‡é‡Œæˆ‘å†™çš„æ¶ˆè´¹è¿›åº¦çš„æ¦‚å¿µï¼Œå®ƒä»£è¡¨å®¢æˆ·ç«¯ç›®å‰æ¶ˆè´¹åˆ°é˜Ÿåˆ—ä¸­å“ªä¸ªä½ç½®ã€‚é›†ç¾¤æ¨¡å¼ä¸‹ Consumer ä¼šæŠŠæ¶ˆè´¹ä½ç‚¹æäº¤ç»™ Brokerï¼›å¹¿æ’­æ¨¡å¼ä¸‹åˆ™ç”± Consumer è‡ªè¡Œä¿å­˜ã€‚</p><p>Consumer å¯åŠ¨æ—¶æœ‰ä¸‰ç§åˆå§‹æ¶ˆè´¹ä½ç‚¹çš„é€‰æ‹©ï¼š<code>CONSUME_FROM_LAST_OFFSET</code>ã€<code>CONSUME_FROM_FIRST_OFFSET</code>ã€<code>CONSUME_FROM_TIMESTAMP</code>ã€‚</p><p>åˆå§‹æ¶ˆè´¹ä½ç‚¹çš„å€¼å­˜å‚¨äº:<code>DefaultMQPushConsumer.consumeFromWhere</code>ã€‚</p><h3 id="è®¢é˜…å…³ç³»-è®¢é˜…å…³ç³»ä¸€è‡´" tabindex="-1"><a class="header-anchor" href="#è®¢é˜…å…³ç³»-è®¢é˜…å…³ç³»ä¸€è‡´"><span>è®¢é˜…å…³ç³» &amp;&amp; è®¢é˜…å…³ç³»ä¸€è‡´</span></a></h3><p>æ¶ˆè´¹è€…ç»„è®¢é˜… Topic+Tagï¼Œå«è®¢é˜…å…³ç³»ã€‚</p><p>è®¢é˜…å…³ç³»ä¸€è‡´ï¼šåŒä¸€ä¸ªæ¶ˆè´¹è€…ç»„ä¸‹æ‰€æœ‰ Consumer è®¢é˜…çš„ Topic+Tag å¿…é¡»å®Œå…¨ä¸€è‡´ã€‚</p><p>å¦‚æœè®¢é˜…å…³ç³»ä¸ä¸€è‡´ï¼Œä¼šå¯¼è‡´æ¶ˆè´¹é”™ä¹±å’Œæ¶ˆæ¯ä¸¢å¤±ã€‚</p><p>Consumer --n:1-- ConsumerGroup --1:1--&gt; Topic + Tagã€‚</p><p>ä¸æƒ³ç”»å›¾ï¼Œè¯¦è§<a href="https://rocketmq.apache.org/zh/docs/4.x/bestPractice/07subscribe" target="_blank" rel="noopener noreferrer">å®˜æ–¹æ–‡æ¡£-4.x-è®¢é˜…å…³ç³»ä¸€è‡´<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>ã€‚</p><h2 id="æºç åˆ†æ" tabindex="-1"><a class="header-anchor" href="#æºç åˆ†æ"><span>æºç åˆ†æ</span></a></h2><p>ä¸»çº¿é€»è¾‘æ˜¯ä» <code>DefaultMQPushConsumer</code> å…¥æ‰‹ï¼Œä»‹ç» push/pull çš„å®ç°ï¼Œé›†ç¾¤å’Œå¹¿æ’­æ¨¡å¼ä¸‹çš„å…·ä½“ç»†èŠ‚ç­‰ã€‚</p><h3 id="æ¶ˆè´¹ç«¯çš„å®ç°ç±»" tabindex="-1"><a class="header-anchor" href="#æ¶ˆè´¹ç«¯çš„å®ç°ç±»"><span>æ¶ˆè´¹ç«¯çš„å®ç°ç±»</span></a></h3><p>Consumer è·Ÿ Producer ä¸€æ ·ä¹Ÿæ˜¯ Netty å®¢æˆ·ç«¯ï¼Œç›¸ä¼¼é€»è¾‘ä¸å†è§£é‡Šã€‚</p><p>ä»æºç å¯ä»¥çœ‹åˆ°ï¼Œ<code>DefaultMQPullConsumer</code> å’Œå…¶å†…éƒ¨å®ç°ç±» <code>DefaultMQPullConsumerImpl</code> å·²ç»è¢«æ ‡æ³¨ Deprecatedï¼ŒPULL æ¨¡å¼ç›®å‰é»˜è®¤ä¸º <code>DefaultLitePullConsumer</code>ã€‚</p><p>æˆ‘ä»¬ä» <code>DefaultMQPushConsumer</code> å¼€å§‹ã€‚</p><h3 id="consumer-å¯åŠ¨æµç¨‹" tabindex="-1"><a class="header-anchor" href="#consumer-å¯åŠ¨æµç¨‹"><span>Consumer å¯åŠ¨æµç¨‹</span></a></h3><p><code>DefaultMQPushConsumer::start</code>ï¼Œè¿™é‡Œé¢æœ‰ä¸€æ­¥è®¾ç½®æ¶ˆè´¹ç»„ï¼Œé‡è¯•ç»„å’Œ DLQ å‘½åç©ºé—´çš„åŒ…è£…ä¹Ÿä¼šåœ¨è¿™é‡Œè¿›è¡Œï¼Œä¹‹åå°±æ˜¯ <code>defaultMQPushConsumerImpl.start();</code>ï¼Œå¦‚æœå¼€å¯æ¶ˆæ¯è¿½è¸ªï¼Œé‚£ä¹ˆè¿˜ä¼šå¯åŠ¨ <code>traceDispatcher.start();</code>ã€‚</p><p>ç„¶åæ¥çœ‹ <code>defaultMQPushConsumerImpl.start();</code>ï¼š</p><ul><li>defaultMQPushConsumerImpl.start</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>
<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">CREATE_JUST</span><span class="token operator">:</span>
        <span class="token comment">// ... çœç•¥æ—¥å¿—</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> <span class="token class-name">ServiceState</span><span class="token punctuation">.</span><span class="token constant">START_FAILED</span><span class="token punctuation">;</span>
        <span class="token comment">// æ ¡éªŒ Consumer å®¢æˆ·ç«¯é…ç½®ï¼Œä¸æ¸…æ¥šå®¢æˆ·ç«¯é…ç½®çš„å¯ä»¥å»çœ‹ä¸€çœ¼</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è¿™é‡Œåšä¸¤ä»¶äº‹</span>
        <span class="token comment">// 1. æŠŠ defaultMQPushConsumer ä¸­çš„è®¢é˜…å¤åˆ¶ä¸€ä»½ç»™ rebalanceImpl</span>
        <span class="token comment">// 2. å¦‚æœæ˜¯ MessageModel æ˜¯é›†ç¾¤æ¨¡å¼ï¼Œé‚£ä¹ˆåˆ›å»º retryTopicï¼Œå¹¶å†ä¸€å¤åˆ¶è®¢é˜…å…³ç³»ï¼Œä¸€èµ·æ·»åŠ åˆ° rebalanceImpl</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">copySubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// InstanceName æ ¡éªŒï¼Œå…¶å®è¿™ä¸€æ­¥å¯ä»¥æ”¾è¿› checkConfig()æ–¹æ³•é‡Œ</span>
        <span class="token comment">// å¦‚æœä½ çš„ InatanceName æ˜¯é»˜è®¤å€¼ï¼Œå°†ä¿®æ”¹ä¸º PID+çº³ç§’çº§æ—¶é—´æˆ³</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">MessageModel</span><span class="token punctuation">.</span><span class="token constant">CLUSTERING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">changeInstanceNameToPID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// è·Ÿ Producer ä¸€æ ·ï¼Œåˆ›å»º netty å®¢æˆ·ç«¯</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory <span class="token operator">=</span> <span class="token class-name">MQClientManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrCreateMQClientInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcHook<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è£…é… rebalanceImpl ï¼Œå…³äº RebalanceImpl åé¢å†è¯´ï¼Œä½ çŸ¥é“ä»–æ˜¯ä¸ªæ¶ˆè´¹è¡Œä¸ºä¹‹å‰çš„è´Ÿè½½å‡è¡¡å™¨å³å¯</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setConsumerGroup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setAllocateMessageQueueStrategy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getAllocateMessageQueueStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setmQClientFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// æ‹‰å–æ¶ˆæ¯ API çš„åŒ…è£…å™¨</span>
        <span class="token comment">// æ— è®ºpull or push æ¨¡å¼ï¼Œéƒ½æ˜¯ consumer ä» broker ä¸ŠæŠŠæ¶ˆæ¯æ‹‰å›æœ¬åœ°å†è¿›è¡Œå¤„ç†</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pullAPIWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PullAPIWrapper</span><span class="token punctuation">(</span>
            mQClientFactory<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">isUnitMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pullAPIWrapper<span class="token punctuation">.</span><span class="token function">registerFilterMessageHook</span><span class="token punctuation">(</span>filterMessageHookList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// è¿™é‡Œåˆæ¥åˆ°ä¸€ä¸ª Deprecated æ–¹æ³•</span>
        <span class="token comment">// è¿™éƒ¨åˆ†å°±æ˜¯å‰æ–‡æåˆ°çš„æ¶ˆè´¹ä½ç‚¹çš„å­˜å‚¨</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getOffsetStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getOffsetStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token comment">// æ ¹æ®æ¶ˆè´¹æ¨¡å¼åˆ¤å®š</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token constant">BROADCASTING</span><span class="token operator">:</span> <span class="token comment">// å¹¿æ’­æ¨¡å¼æœ¬åœ°å­˜å–ï¼Œè¿™é‡Œåªåˆå§‹åŒ– offsetStore</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalFileOffsetStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">CLUSTERING</span><span class="token operator">:</span> <span class="token comment">// é›†ç¾¤æ¨¡å¼ï¼Œæ¶ˆè´¹ä½ç‚¹è¦ä¸Šä¼  brokerï¼Œæ‰€ä»¥è¿™é‡Œè¦ä» broker ä¸Šæ‹‰</span>
                    <span class="token comment">// è¿™é‡Œåˆå§‹åŒ– offsetStore</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RemoteBrokerOffsetStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// ç»™å¤–éƒ¨åŒ…è£…ç±»åˆå§‹åŒ– offsetStore</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">setOffsetStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// offsetStore çš„å…·ä½“ç±»å‹å–å†³äºä¸Šé¢çš„ä»£ç ï¼Œ LocalFileOffsetStore or RemoteBrokerOffsetStore</span>
        <span class="token comment">// LocalFileOffsetStore.load å°±æ˜¯ä»æœ¬åœ°æ–‡ä»¶ä¸­å–å‡ºæ¶ˆè´¹ä½ç‚¹</span>
        <span class="token comment">// è·¯å¾„æ˜¯ user.home/.rocketmq_offsets/clientID/groupName/offsets.json</span>
        <span class="token comment">// æµç¨‹å°±æ˜¯ è¯»æ–‡ä»¶ï¼Œç„¶å json åºåˆ—åŒ–ä¸º wrapper å¯¹è±¡ï¼Œç„¶åæŠŠå¯¹è±¡çš„å€¼ä¼ ç»™ offsetTableï¼Œé¡ºå¸¦æ‰“å° load æ—¥å¿—</span>

        <span class="token comment">// é›†ç¾¤æ¨¡å¼ä» Broker è¿œç¨‹æ‹‰å–ï¼Œæ‰€ä»¥ RemoteBrokerOffsetStore::load å•¥ä¹Ÿä¸å¹²ã€‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageListenerInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">MessageListenerOrderly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// é¡ºåºæ¶ˆè´¹ -&gt; ConsumeMessageOrderlyService</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumeOrderly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumeMessageService <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">ConsumeMessageOrderlyService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">MessageListenerOrderly</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageListenerInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageListenerInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// å¹¶å‘æ¶ˆè´¹ -&gt; ConsumeMessageConcurrentlyService</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumeOrderly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumeMessageService <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">ConsumeMessageConcurrentlyService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageListenerInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ConsumeMessageOrderlyService ä»…é€‚ç”¨äºé›†ç¾¤æ¨¡å¼</span>
        <span class="token comment">// å®ƒä¼šæäº¤ä¸€ä¸ªå‘¨æœŸä»»åŠ¡ç»™ scheduledExecutorServiceï¼ˆå•çº¿ç¨‹ï¼‰ï¼ŒscheduledExecutorService æ¯ 20 ç§’è°ƒç”¨ rebalanceImpl().lockAll() å¯¹è¿œç¨‹é˜Ÿåˆ—ä¸Šé”ã€‚</span>

        <span class="token comment">// ConsumeMessageConcurrentlyService</span>
        <span class="token comment">// æäº¤ä¸€ä¸ªå‘¨æœŸä»»åŠ¡ç»™ cleanExpireMsgExecutorsï¼ˆå•çº¿ç¨‹ï¼‰ï¼Œæ¯ 15 åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡è¿‡æœŸæ¶ˆæ¯ï¼Œé¿å…æ¶ˆè´¹å¡ä½ã€‚</span>
        <span class="token comment">// åé¢å•ç‹¬æ¥çœ‹è¿™ä¿© Service</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumeMessageService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// å°±æ˜¯æŠŠæ¶ˆè´¹ç»„å’Œå¯¹åº”çš„ Consumer å­˜å…¥ consumerTable</span>
        <span class="token keyword">boolean</span> registerOK <span class="token operator">=</span> mQClientFactory<span class="token punctuation">.</span><span class="token function">registerConsumer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registerOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// æ³¨å†Œå¤±è´¥ç›´æ¥å…³é—­</span>
          <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ä¸»è¦çœ‹è¿™ä¸ªæ–¹æ³•</span>
        mQClientFactory<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;the consumer [{}] start OK.&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> <span class="token class-name">ServiceState</span><span class="token punctuation">.</span><span class="token constant">RUNNING</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">RUNNING</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token constant">START_FAILED</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token constant">SHUTDOWN_ALREADY</span><span class="token operator">:</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">&quot;The PushConsumer service state not OK, maybe started once, &quot;</span>
              <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState
              <span class="token operator">+</span> <span class="token class-name">FAQUrl</span><span class="token punctuation">.</span><span class="token function">suggestTodo</span><span class="token punctuation">(</span><span class="token class-name">FAQUrl</span><span class="token punctuation">.</span><span class="token constant">CLIENT_SERVICE_NOT_OK</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ä» NameSrv æ›´æ–°è·¯ç”±ä¿¡æ¯ï¼Œå¹¶å­˜å…¥ topicRouteTable</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateTopicSubscribeInfoWhenSubscriptionChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å‘é€è¿œç¨‹è¯·æ±‚ RequestCode.CHECK_CLIENT_CONFIG</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">checkClientInBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">sendHeartbeatToAllBrokerWithLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// å¯åŠ¨ rebalanceService</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">rebalanceImmediately</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>mQClientFactory.start();</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>      <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> <span class="token class-name">ServiceState</span><span class="token punctuation">.</span><span class="token constant">START_FAILED</span><span class="token punctuation">;</span>
      <span class="token comment">// If not specified,looking address from name server</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientConfig<span class="token punctuation">.</span><span class="token function">getNamesrvAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientAPIImpl<span class="token punctuation">.</span><span class="token function">fetchNameServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Start request-response channel</span>
      <span class="token comment">// netty client</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientAPIImpl<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Start various schedule tasks</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startScheduledTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Start pull service</span>
      <span class="token comment">// é‡ç‚¹çœ‹ pullMessageService</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pullMessageService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Start rebalance service</span>
      <span class="token comment">// rebalanceService ä¸»è¦æ˜¯å®šæœŸæ‰§è¡Œ doRebalance</span>
      <span class="token comment">// doRebalance æœ‰ä¸‰ç§å®ç°æ–¹æ³•ï¼Œå¯¹åº”ä¸åŒ Consumer å®ç°ç±»</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Start push service</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getDefaultMQProducerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;the client factory [{}] start OK&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> <span class="token class-name">ServiceState</span><span class="token punctuation">.</span><span class="token constant">RUNNING</span><span class="token punctuation">;</span>          
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>æ€»ç»“</li></ul><p>åˆ°è¿™é‡Œå¯åŠ¨å°±å®Œæˆäº†ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹å¯åŠ¨æµç¨‹ï¼š<br> ç¬¬ä¸€æ­¥ï¼Œåˆå§‹åŒ–å’Œç»„è£… <code>rebalanceImpl</code> å’Œ Consumer ï¼›<br> ç¬¬äºŒæ­¥ï¼Œè½½å…¥æ¶ˆè´¹ä½ç‚¹ï¼Œå¹¿æ’­æ¨¡å¼å­˜åœ¨æœ¬åœ°ï¼Œé›†ç¾¤æ¨¡å¼å­˜å‚¨åœ¨ brokerï¼›<br> ç¬¬ä¸‰æ­¥ï¼Œåˆå§‹åŒ–å¹¶å¯åŠ¨ <code>consumeMessageService</code>ï¼Œå®ç°ç±»æœ‰ä¸¤ä¸ªï¼Œé¡ºåºæ¶ˆè´¹æ˜¯ <code>ConsumeMessageOrderlyService</code>ï¼Œå¹¶è¡Œæ¶ˆè´¹æ˜¯ <code>ConsumeMessageConcurrentlyService</code>ï¼›<br> ç¬¬å››æ­¥ï¼ŒæŠŠ Consumer æ³¨å†Œåˆ° consumerTableï¼› æœ€åå¯åŠ¨ Consumer å’Œå„ç§ Servicesã€‚</p><p>ç„¶åæˆ‘ä»¬æ¥çœ‹â€œæ¶ˆè´¹â€ã€‚</p><h3 id="consumemessageservice" tabindex="-1"><a class="header-anchor" href="#consumemessageservice"><span>ConsumeMessageService</span></a></h3><p>æ¶ˆè´¹è¿™éƒ¨åˆ†ä¸»è¦å…³æ³¨ <code>ConsumeMessageService</code> å’Œ <code>PullMessageService</code>è¿™ä¸¤å—ã€‚</p><p><code>ConsumeMessageService</code> å‰é¢å·²ç»çœ‹åˆ°äº†ï¼Œå®ƒæœ‰é¡ºåºæ¶ˆè´¹å’Œå¹¶å‘æ¶ˆè´¹ä¸¤ä¸ªå®ç°ç±»ï¼Œè¿™ä¸ª Service ä¸»è¦èŒè´£å°±æ˜¯è´Ÿè´£æ¶ˆè´¹æ¶ˆæ¯ã€‚</p><ul><li><p>ConsumeMessageOrderlyService é¡ºåºæ¶ˆè´¹</p><p>æ— è®ºæ˜¯å“ªä¸ªå®ç°ç±»ï¼Œ<code>ConsumeMessageService</code> ä¸€å®šä¼šæœ‰ <code>consumeExecutor</code> å±æ€§ï¼Œå®ƒæ˜¯æ‰§è¡Œæ¶ˆè´¹è¡Œä¸ºçš„çº¿ç¨‹/çº¿ç¨‹æ± ï¼Œè¿™é‡Œå°±ç»Ÿç§°æ‰§è¡Œå™¨ã€‚<code>private final ThreadPoolExecutor consumeExecutor;</code>ã€‚</p><p><code>ConsumeMessageOrderlyService</code> çš„ <code>consumeExecutor</code> æ˜¯ä¸€ä¸ªåŒ…å« 20 ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œå¹¶å‘ç‰ˆæœ¬çš„ä¹Ÿä¸€æ ·ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>consumeExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumeThreadMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// core 20</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumeThreadMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// max 20</span>
        <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumeRequestQueue<span class="token punctuation">,</span> <span class="token comment">// workQueue LinkedBlockingQueue</span>
        <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">&quot;ConsumeMessageThread_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>çº¿ç¨‹æ± æœ‰äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çº¿ç¨‹æ± è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼š <code>ConsumeRequest</code>ã€‚</p><p>ä»£ç å¤ªé•¿è¿˜æ˜¯å¤§é‡çœç•¥ï¼Œé™¤äº†è¦çœ‹ run æ–¹æ³•å¤–ï¼Œè¦æ³¨æ„åˆ›å»º <code>ConsumeRequest</code> æ—¶ï¼Œéœ€è¦æ¥æ”¶ä¸¤ä¸ªé˜Ÿåˆ—ä½œä¸ºå‚æ•°ï¼Œ <code>processQueue</code> å’Œ <code>messageQueue</code>ã€‚</p><p>processQueue æš‚ä¸”å°±ç®€å•ç†è§£ä¸ºå¾…æ¶ˆè´¹çš„æ¶ˆæ¯é˜Ÿåˆ—(local)ï¼ŒmessageQueue å°±æ˜¯å¾…æ‹‰å–çš„æ¶ˆæ¯é˜Ÿåˆ—(remote)ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// ConsumeRequest::run   </span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// é¦–å…ˆæ£€æŸ¥ processQueue.isDropped ...</span>

  <span class="token comment">// ä¸Šé”ï¼Œä¿è¯ä¸€ä¸ªé˜Ÿåˆ—ä¸€æ¬¡åªè¢«ä¸€ä¸ªçº¿ç¨‹æ¶ˆè´¹</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span> objLock <span class="token operator">=</span> messageQueueLock<span class="token punctuation">.</span><span class="token function">fetchLockObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ†æ”¯åˆ¤æ–­</span>
    <span class="token comment">// å¦‚æœæ˜¯å¹¿æ’­æ¨¡å¼ æˆ–è€… processQueue è¢«é”ä½ä¸”é”æœªè¿‡æœŸ åˆ™å¼€å§‹è¿›è¡Œå¾ªç¯</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">boolean</span> continueConsume <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> continueConsume<span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// å½“æˆ while(continueConsume) å³å¯</span>
        <span class="token comment">// å†æ¬¡ æ£€æŸ¥ processQueue.isDropped ï¼Œæ˜¯åˆ™ break</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span> log <span class="token operator">&amp;</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token comment">// å¦‚æœæ˜¯é›†ç¾¤æ¨¡å¼ ä¸” processQueue æœªè¢«é”ä½ï¼Œåˆ™å°è¯•é‡æ–°ä¸Šé”å¹¶é‡æ–°æ¶ˆè´¹</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// è¿™ä¸ªæ–¹æ³•å°±æ˜¯ å…ˆå¯¹ç¬¬ä¸€ä¸ªå‚æ•° messageQueue ä¸Šé”ï¼Œ</span>
          <span class="token comment">// å¦‚æœæˆåŠŸï¼Œåˆ™ 10ms åé‡æ–°æäº¤ä¸€ä¸ª ConsumeRequest è¯·æ±‚ï¼Œ</span>
          <span class="token comment">// å¦‚æœä¸æˆåŠŸï¼Œåˆ™ 3s åé‡æ–°æäº¤ä¸€ä¸ª ConsumeRequest è¯·æ±‚ã€‚</span>
          <span class="token class-name">ConsumeMessageOrderlyService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryLockLaterAndReconsume</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// å¦‚æœ é›†ç¾¤æ¨¡å¼ ä¸” processQueue é”è¿‡æœŸï¼Œä¹Ÿæ˜¯ tryLockLaterAndReconsume + break; è·Ÿå‰é¢ä¸€æ ·ã€‚</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
        <span class="token comment">// è®¡ç®—çœŸå®æäº¤é—´éš” interval  å½“å‰æ—¶é—´ - beginTimeï¼Œæ³¨æ„ beginTime åœ¨å¾ªç¯å¤–</span>
        <span class="token keyword">long</span> interval <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beginTime<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interval <span class="token operator">&gt;</span> <span class="token constant">MAX_TIME_CONSUME_CONTINUOUSLY</span> <span class="token comment">/*60s*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// MAX_TIME_CONSUME_CONTINUOUSLY æ˜¯ rocketmq.client.maxTimeConsumeContinuously çš„å€¼ã€‚</span>
            <span class="token class-name">ConsumeMessageOrderlyService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">submitConsumeRequestLater</span><span class="token punctuation">(</span>processQueue<span class="token punctuation">,</span> messageQueue<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// ä»¥ä¸Šçš„å››ä¸ª if + break éƒ½æ˜¯ä¸ºäº†ä¿è¯å½“å‰æ¶ˆæ¯ä¸€å®šè¦è¢«æ¶ˆè´¹</span>

        <span class="token comment">// ç„¶åæ˜¯æ¶ˆæ¯çš„æ‰¹é‡å¤„ç† consumeMessageBatchMaxSize é»˜è®¤ä¸º 1</span>
        <span class="token comment">// ä» processQueue.takeMessages æ–¹æ³•ä¸­å°±å¯ä»¥çœ‹å‡ºæ¥ï¼Œ</span>
        <span class="token comment">// å¹³æ—¶æ¶ˆæ¯æ˜¯å­˜å‚¨äº msgTreeMap ä¸­ï¼Œåªæœ‰é¡ºåºæ¶ˆè´¹æ—¶æ‰å–å‡ºå¯¹åº”æ•°é‡æ¶ˆæ¯å†™å…¥ consumingMsgOrderlyTreeMap</span>
         <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">takeMessages</span><span class="token punctuation">(</span>consumeBatchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åˆ›å»ºå¹¶è£…é… ConsumeOrderlyContext ç•¥</span>

        <span class="token comment">// è¿™é‡Œå°±æ˜¯ä½ è‡ªå·±å®ç°çš„ Consumer.registerMessageListener é‡Œé¢</span>
        <span class="token comment">// æ³¨å†Œå¹¶å®ç°çš„ listener çš„ consumeMessage æ–¹æ³•çš„è°ƒç”¨ã€‚</span>
        <span class="token comment">// æ¢å¥è¯è¯´è¿™ä¸€æ­¥å°±æ˜¯æ‰§è¡ŒçœŸæ­£çš„æ¶ˆè´¹</span>
        status <span class="token operator">=</span> messageListener<span class="token punctuation">.</span><span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// åé¢å…¨éƒ¨ç•¥ æœ‰å…´è¶£å¯ä»¥è‡ªå·±çœ‹ï¼Œå°±æ˜¯ä¸€äº›åç»­å¤„ç† ...</span>
        <span class="token comment">// é€€å‡ºå¾ªç¯çš„æ¡ä»¶å°±æ˜¯ continueConsume == falseï¼›</span>

        <span class="token comment">// æ¶ˆè´¹çš„æœ€åä¸€æ­¥ï¼Œ ack æ¶ˆæ¯</span>
         continueConsume <span class="token operator">=</span> <span class="token class-name">ConsumeMessageOrderlyService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processConsumeResult</span><span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> status<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥çŸ¥é“é¡ºåºæ¶ˆè´¹æ—¶ï¼ŒProcessQueue ä¼šä» msgTreeMap ä¸­å–å‡º batchSizeï¼ˆé»˜è®¤ä¸º 1ï¼‰æ¡æ¶ˆæ¯å­˜å…¥ consumingMsgOrderlyTreeMap å¹¶è¿›è¡Œæ‰¹é‡æ¶ˆè´¹ã€‚</p><p>ç›®å‰æ‰§è¡Œå™¨ <code>consumeExecutor</code> å’Œçº¿ç¨‹ä»»åŠ¡ <code>ConsumeRequest</code> éƒ½æœ‰äº†ï¼Œé‚£ä¹ˆ <code>ConsumeRequest</code> æ˜¯å¦‚ä½•æäº¤ç»™ <code>consumeExecutor</code> çš„å·¥ä½œé˜Ÿåˆ—çš„å‘¢ï¼Ÿ</p><p>å°±æ˜¯ <code>ConsumeMessageOrderlyService::submitConsumeRequest</code> æ–¹æ³•ï¼Œéå¸¸ç®€å•ï¼Œæ ¹æ®å‚æ•°æä¾›çš„ä¿© Queue æ¥åˆ›å»ºä¸€ä¸ª <code>ConsumeRequest</code>ï¼Œç„¶åç›´æ¥æäº¤ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submitConsumeRequest</span><span class="token punctuation">(</span>
    <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">ProcessQueue</span> processQueue<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">MessageQueue</span> messageQueue<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> dispathToConsume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dispathToConsume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConsumeRequest</span> consumeRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeRequest</span><span class="token punctuation">(</span>processQueue<span class="token punctuation">,</span> messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumeExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è‡³æ­¤ï¼Œå›´ç»• <code>consumeExecutor</code> çš„åŸºæœ¬è¦ç´ å·²ç»å‡‘é½ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬è¦æ¥çœ‹æ¶ˆæ¯æ˜¯æ€ä¹ˆä» broker ä¼ é€’è¿‡æ¥çš„ï¼Œç„¶åç»è¿‡äº†å“ªäº›å¤„ç†ï¼Œæœ€åå¦‚ä½•è¢«æäº¤ç»™ <code>consumeExecutor</code> çš„ã€‚ æ¢å¥è¯è¯´å°±æ˜¯ï¼š<code>ConsumeMessageOrderlyService::submitConsumeRequest</code> è¿™ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„ã€‚</p><p>ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬å°±ä¸ä» <code>submitConsumeRequest</code> å‘ä¸Šè¿½è¸ªäº†ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œä»åæ¨éªŒè¯ã€‚</p></li></ul><h3 id="pullmessageservice" tabindex="-1"><a class="header-anchor" href="#pullmessageservice"><span>PullMessageService</span></a></h3><p>è¿˜è®°å¾—å‰é¢å¯åŠ¨æµç¨‹ä¸­æ³¨é‡Šäº†é‡ç‚¹çš„ <code>this.pullMessageService.start();</code> ä¹ˆã€‚</p><p><code>PullMessageService</code> æ˜¯å°±æ˜¯è´Ÿè´£æŠŠæ¶ˆæ¯ä» Broker æ‹‰å–åˆ° Consumer æœ¬åœ°ï¼Œå¹¶å°†æ¶ˆæ¯å°è£…æˆ <code>ConsumeRequest</code> æäº¤ç»™çº¿ç¨‹æ± çš„é‡è¦ Service ã€‚</p><p><code>PullMessageService</code> å†…ç»´æŠ¤ä¸€ä¸ªå•çº¿ç¨‹æ‰§è¡Œå™¨ <code>scheduledExecutorService</code>ï¼Œè´Ÿè´£å®šæœŸæŠŠ <code>PullRequest</code> æäº¤åˆ° <code>pullRequestQueue</code> ä¸­ã€‚</p><p>åŒæ—¶ <code>PullMessageService</code> è‡ªèº«ä¹Ÿæ˜¯ä¸€ä¸ªæœåŠ¡çº¿ç¨‹ (ServiceThread, RocketMQ å†…éƒ¨è‡ªå®šä¹‰çš„æŠ½è±¡ç±»)ï¼Œ<code>PullMessageService</code> çš„å·¥ä½œå°±æ˜¯ä¸åœçš„ä» <code>pullRequestQueue</code> ä¸­å–å‡º <code>PullRequest</code> å¹¶æ‰§è¡Œ <code>PullMessageService.pullMessage(final PullRequest pullRequest)</code> æ–¹æ³•å¤„ç†è¯·æ±‚ã€‚</p><p><code>PullMessageService::pullMessage</code> å®é™…ä¸Šä¹Ÿå¹¶ä¸ä¼šçœŸæ­£å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå®ƒåªæ˜¯é€‰æ‹©ä¸€ä¸ª Consumerï¼Œé€šè¿‡è°ƒç”¨ <code>Consumer.pullMessage(final PullRequest pullRequest)</code> æ¥å¤„ç†ã€‚ å¯èƒ½æ˜¯å› ä¸º <code>DefaultMQPullConsumerImpl</code> è¢«å¼ƒç”¨çš„åŸå› ï¼Œè¿™é‡Œå®ƒé»˜è®¤æ‰€æœ‰çš„ Consumer éƒ½æ˜¯ <code>DefaultMQPushConsumerImpl</code> ç±»å‹ï¼Œï¼ˆå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼‰ã€‚ å› æ­¤ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ <code>DefaultMQPushConsumerImpl::pullMessage</code> æ‰æ˜¯çœŸæ­£å¤„ç† <code>PullRequest</code> è¯·æ±‚çš„æ–¹æ³•ã€‚ <code>DefaultMQPushConsumerImpl::pullMessage</code> çš„ä¸»è¦å·¥ä½œå°±æ˜¯ä» broker ä¸Šæ‹‰æ¶ˆæ¯å›æ¥ï¼Œå®ƒé‡Œé¢çš„ callback åˆ™æ˜¯å¯¹æ‹‰å›æ¥çš„æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œæ¯”å¦‚è§£ç å•Šã€å­˜å…¥ msgTreeMap å•Šã€æŠŠæ¶ˆæ¯æäº¤ç»™ consumeExecutor å»æ‰§è¡Œä»€ä¹ˆçš„ã€‚</p><ul><li><p>PullMessageService çš„å±æ€§å’ŒåŸºç¡€æ–¹æ³•</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PullMessageService</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceThread</span> <span class="token punctuation">{</span>
  <span class="token comment">// å­˜æ”¾ pullRequest è¯·æ±‚çš„é˜Ÿåˆ—</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PullRequest</span><span class="token punctuation">&gt;</span></span> pullRequestQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PullRequest</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MQClientInstance</span> mQClientFactory<span class="token punctuation">;</span>
  <span class="token comment">// å•çº¿ç¨‹ã€å‘¨æœŸæ‰§è¡Œ</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ScheduledExecutorService</span> scheduledExecutorService <span class="token operator">=</span> <span class="token class-name">Executors</span>
      <span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">&quot;PullMessageServiceScheduledThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// æ„é€ æ–¹æ³•</span>
  <span class="token keyword">public</span> <span class="token class-name">PullMessageService</span><span class="token punctuation">(</span><span class="token class-name">MQClientInstance</span> mQClientFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory <span class="token operator">=</span> mQClientFactory<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// PullMessageService çš„ run æ–¹æ³•</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; service started&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token comment">// ä» pullRequestQueue ä¸­å–å‡º pullRequest</span>
              <span class="token class-name">PullRequest</span> pullRequest <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pullRequestQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// è½¬äº¤ç»™ consumer.pullMessage å»æ‰§è¡Œ</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pullMessage</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Pull Message Service Run Method exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; service end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>pullRequest å­˜å…¥ pullRequestQueue</p><p>ä¸¤ä¸ªæ–¹æ³•ï¼Œ<code>executePullRequestImmediately</code> å’Œ <code>executePullRequestLater</code>ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">PullRequest</span> pullRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>pullRequestQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;executePullRequestImmediately pullRequestQueue.put&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executePullRequestLater</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">PullRequest</span> pullRequest<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeDelay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// å°±æ˜¯å®šæ—¶è°ƒç”¨ executePullRequestImmediately</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">PullMessageService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">,</span> timeDelay<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;PullMessageServiceScheduledThread has shutdown&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>PullMessageService::pullMessage</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pullMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">PullRequest</span> pullRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ä» MQClientInstance.consumerTable ä¸­ ä»¥ consumerGroup ä¸º KEY å–å‡º consumer</span>
      <span class="token comment">// è¿™ä¸ª consumer å°±æ˜¯ä¹‹å‰ DefaultMQPushConsumerImpl::start ä¸­æ³¨å†Œé‚£ä¸€æ­¥å­˜å…¥ consumerTable çš„</span>
      <span class="token keyword">final</span> <span class="token class-name">MQConsumerInner</span> consumer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">selectConsumer</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>consumer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// å¼ºè½¬</span>
          <span class="token class-name">DefaultMQPushConsumerImpl</span> impl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">)</span> consumer<span class="token punctuation">;</span>
          <span class="token comment">// å®é™…å¤„ç†</span>
          impl<span class="token punctuation">.</span><span class="token function">pullMessage</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;No matched consumer for the PullRequest {}, drop it&quot;</span><span class="token punctuation">,</span> pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>PullRequest</p><p>çœ‹å¦‚ä½•å¤„ç† <code>PullRequest</code> è¯·æ±‚å‰ï¼Œå…ˆçœ‹ä¸€ä¸‹å®ƒæ˜¯ä»€ä¹ˆã€‚</p><p>ç®€å•çš„è¯´å°±æ˜¯æ‹‰å–æ¶ˆæ¯çš„è¯·æ±‚ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// PullRequest å±æ€§ã€é‡è¦é‡å†™ Override æ–¹æ³•</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PullRequest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> consumerGroup<span class="token punctuation">;</span>
    <span class="token comment">// è¿™ä¿© Queue è·Ÿ ConsumeRequest ä¸­è¯­ä¹‰ä¸€è‡´</span>
    <span class="token comment">// ä»£è¡¨è¿œç¨‹ Queue</span>
    <span class="token comment">// å®ƒé‡Œé¢åªå­˜å‚¨ topic + brokerName + queueID</span>
    <span class="token comment">// è¿™ä¸‰ä¸ªå±æ€§è¶³å¤Ÿ Consumer ç¡®å®šè‡ªå·±ä»å“ªä¸ª Broker æ‰¾åˆ°å“ªä¸ª topic ä¸‹çš„å“ªä¸ªé˜Ÿåˆ—</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageQueue</span> messageQueue<span class="token punctuation">;</span>
    <span class="token comment">// æ¶ˆæ¯å­˜å…¥çš„æœ¬åœ° Queue</span>
    <span class="token comment">// ProcessQueue å¯ä»¥è‡ªå·±å»çœ‹ä¸€ä¸‹</span>
    <span class="token keyword">private</span> <span class="token class-name">ProcessQueue</span> processQueue<span class="token punctuation">;</span>
    <span class="token comment">// è¿œç¨‹ Queue çš„ offsetï¼Œæ¶ˆè´¹è¿›åº¦ï¼Œæ¶ˆè´¹ä½ç‚¹</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> nextOffset<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> previouslyLocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>


    <span class="token comment">// hashcode:  (1*31 + consumerGroup.hashcode) * 31 + messageQueue.hashcode</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> prime <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> prime <span class="token operator">*</span> result <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>consumerGroup <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> consumerGroup<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> prime <span class="token operator">*</span> result <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>messageQueue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> messageQueue<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> obj<span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token class-name">PullRequest</span> other <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PullRequest</span><span class="token punctuation">)</span> obj<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>consumerGroup <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>other<span class="token punctuation">.</span>consumerGroup <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
              <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>consumerGroup<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>consumerGroup<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>messageQueue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>other<span class="token punctuation">.</span>messageQueue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
              <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageQueue<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>messageQueue<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ƒçš„ hashCode è®¡ç®—æ–¹å¼ç±»ä¼¼ String.hashCodeï¼ŒåŸºæœ¬ä¸Šä¹Ÿæ˜¯åŸºäºä»¥ä¸‹å…¬å¼ï¼š</p><mjx-container class="MathJax" jax="SVG" overflow="overflow" display="true" style="position:relative;"><svg style="vertical-align:-0.561ex;" xmlns="http://www.w3.org/2000/svg" width="27.863ex" height="2.253ex" role="img" focusable="false" viewBox="0 -748 12315.6 996" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtext"><path data-c="A0" d=""></path></g><g data-mml-node="mi" transform="translate(332,0)"><path data-c="1D453" d="M552 636C552 682 506 705 465 705C431 705 368 687 338 588C332 567 329 557 305 431L236 431C217 431 206 431 206 412C206 400 215 400 234 400L300 400L225 5C207-92 190-183 138-183C134-183 109-183 90-165C136-162 145-126 145-111C145-88 127-76 108-76C82-76 53-98 53-136C53-181 97-205 138-205C193-205 233-146 251-108C283-45 306 76 307 83L367 400L453 400C473 400 483 400 483 420C483 431 473 431 456 431L373 431C384 489 383 487 394 545C398 566 412 637 418 649C427 668 444 683 465 683C469 683 495 683 514 665C470 661 460 626 460 611C460 588 478 576 497 576C523 576 552 598 552 636Z"></path></g><g data-mml-node="mo" transform="translate(884,0)"><path data-c="28" d="M332-238C332-235 330-232 328-230C224-152 155 48 155 208L155 292C155 452 224 652 328 730C330 732 332 735 332 738C332 743 327 748 322 748C320 748 318 747 316 746C206 663 101 463 101 292L101 208C101 37 206-163 316-246C318-247 320-248 322-248C327-248 332-243 332-238Z"></path></g><g data-mml-node="msub" transform="translate(1273,0)"><g data-mml-node="mi"><path data-c="1D465" d="M527 376C527 428 468 442 434 442C376 442 341 389 329 366C304 432 250 442 221 442C117 442 60 313 60 288C60 278 72 278 72 278C80 278 83 280 85 289C119 395 185 420 219 420C238 420 273 411 273 353C273 322 256 255 219 115C203 53 168 11 124 11C118 11 95 11 74 24C99 29 121 50 121 78C121 105 99 113 84 113C54 113 29 87 29 55C29 9 79-11 123-11C189-11 225 59 228 65C240 28 276-11 336-11C439-11 496 118 496 143C496 153 487 153 484 153C475 153 473 149 471 142C438 35 370 11 338 11C299 11 283 43 283 77C283 99 289 121 300 165L334 302C340 328 363 420 433 420C438 420 462 420 483 407C455 402 435 377 435 353C435 337 446 318 473 318C495 318 527 336 527 376Z"></path></g><g data-mml-node="TeXAtom" transform="translate(605,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D45B" d="M571 143C571 153 562 153 559 153C549 153 549 150 544 135C524 67 491 11 442 11C425 11 418 21 418 44C418 69 427 93 436 115C455 168 497 278 497 335C497 402 454 442 382 442C292 442 243 378 226 355C221 411 180 442 134 442C88 442 69 403 59 385C43 351 29 292 29 288C29 278 41 278 41 278C51 278 52 279 58 301C75 372 95 420 131 420C151 420 162 407 162 374C162 353 159 342 146 290L88 59C85 44 79 21 79 16C79-2 93-11 108-11C120-11 138-3 145 17C146 19 158 66 164 91L186 181C192 203 198 225 203 248L216 298C231 329 284 420 379 420C424 420 433 383 433 350C433 288 384 160 368 117C359 94 358 82 358 71C358 24 393-11 440-11C534-11 571 135 571 143Z"></path></g><g data-mml-node="mo" transform="translate(600,0)"><path data-c="2B" d="M722 250C722 261 713 270 702 270L409 270L409 563C409 574 400 583 389 583C378 583 369 574 369 563L369 270L76 270C65 270 56 261 56 250C56 239 65 230 76 230L369 230L369-63C369-74 378-83 389-83C400-83 409-74 409-63L409 230L702 230C713 230 722 239 722 250Z"></path></g><g data-mml-node="mn" transform="translate(1378,0)"><path data-c="31" d="M419 0L419 31L387 31C297 31 294 42 294 79L294 640C294 664 294 666 271 666C209 602 121 602 89 602L89 571C109 571 168 571 220 597L220 79C220 43 217 31 127 31L95 31L95 0C130 3 217 3 257 3C297 3 384 3 419 0Z"></path></g></g></g><g data-mml-node="mo" transform="translate(3255.9,0)"><path data-c="29" d="M288 208L288 292C288 463 183 663 73 746C71 747 69 748 67 748C62 748 57 743 57 738C57 735 59 732 61 730C165 652 234 452 234 292L234 208C234 48 165-152 61-230C59-232 57-235 57-238C57-243 62-248 67-248C69-248 71-247 73-246C183-163 288 37 288 208Z"></path></g><g data-mml-node="mo" transform="translate(3922.7,0)"><path data-c="3D" d="M722 347C722 358 713 367 702 367L76 367C65 367 56 358 56 347C56 336 65 327 76 327L702 327C713 327 722 336 722 347ZM722 153C722 164 713 173 702 173L76 173C65 173 56 164 56 153C56 142 65 133 76 133L702 133C713 133 722 142 722 153Z"></path></g><g data-mml-node="mn" transform="translate(4978.5,0)"><path data-c="33" d="M457 171C457 253 394 331 290 352C372 379 430 449 430 528C430 610 342 666 246 666C145 666 69 606 69 530C69 497 91 478 120 478C151 478 171 500 171 529C171 579 124 579 109 579C140 628 206 641 242 641C283 641 338 619 338 529C338 517 336 459 310 415C280 367 246 364 221 363C213 362 189 360 182 360C174 359 167 358 167 348C167 337 174 337 191 337L235 337C317 337 354 269 354 171C354 35 285 6 241 6C198 6 123 23 88 82C123 77 154 99 154 137C154 173 127 193 98 193C74 193 42 179 42 135C42 44 135-22 244-22C366-22 457 69 457 171Z"></path><path data-c="31" d="M419 0L419 31L387 31C297 31 294 42 294 79L294 640C294 664 294 666 271 666C209 602 121 602 89 602L89 571C109 571 168 571 220 597L220 79C220 43 217 31 127 31L95 31L95 0C130 3 217 3 257 3C297 3 384 3 419 0Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(6200.7,0)"><path data-c="22C5" d="M192 250C192 279 168 303 139 303C110 303 86 279 86 250C86 221 110 197 139 197C168 197 192 221 192 250Z"></path></g><g data-mml-node="mi" transform="translate(6700.9,0)"><path data-c="1D453" d="M552 636C552 682 506 705 465 705C431 705 368 687 338 588C332 567 329 557 305 431L236 431C217 431 206 431 206 412C206 400 215 400 234 400L300 400L225 5C207-92 190-183 138-183C134-183 109-183 90-165C136-162 145-126 145-111C145-88 127-76 108-76C82-76 53-98 53-136C53-181 97-205 138-205C193-205 233-146 251-108C283-45 306 76 307 83L367 400L453 400C473 400 483 400 483 420C483 431 473 431 456 431L373 431C384 489 383 487 394 545C398 566 412 637 418 649C427 668 444 683 465 683C469 683 495 683 514 665C470 661 460 626 460 611C460 588 478 576 497 576C523 576 552 598 552 636Z"></path></g><g data-mml-node="mo" transform="translate(7252.9,0)"><path data-c="28" d="M332-238C332-235 330-232 328-230C224-152 155 48 155 208L155 292C155 452 224 652 328 730C330 732 332 735 332 738C332 743 327 748 322 748C320 748 318 747 316 746C206 663 101 463 101 292L101 208C101 37 206-163 316-246C318-247 320-248 322-248C327-248 332-243 332-238Z"></path></g><g data-mml-node="msub" transform="translate(7641.9,0)"><g data-mml-node="mi"><path data-c="1D465" d="M527 376C527 428 468 442 434 442C376 442 341 389 329 366C304 432 250 442 221 442C117 442 60 313 60 288C60 278 72 278 72 278C80 278 83 280 85 289C119 395 185 420 219 420C238 420 273 411 273 353C273 322 256 255 219 115C203 53 168 11 124 11C118 11 95 11 74 24C99 29 121 50 121 78C121 105 99 113 84 113C54 113 29 87 29 55C29 9 79-11 123-11C189-11 225 59 228 65C240 28 276-11 336-11C439-11 496 118 496 143C496 153 487 153 484 153C475 153 473 149 471 142C438 35 370 11 338 11C299 11 283 43 283 77C283 99 289 121 300 165L334 302C340 328 363 420 433 420C438 420 462 420 483 407C455 402 435 377 435 353C435 337 446 318 473 318C495 318 527 336 527 376Z"></path></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D45B" d="M571 143C571 153 562 153 559 153C549 153 549 150 544 135C524 67 491 11 442 11C425 11 418 21 418 44C418 69 427 93 436 115C455 168 497 278 497 335C497 402 454 442 382 442C292 442 243 378 226 355C221 411 180 442 134 442C88 442 69 403 59 385C43 351 29 292 29 288C29 278 41 278 41 278C51 278 52 279 58 301C75 372 95 420 131 420C151 420 162 407 162 374C162 353 159 342 146 290L88 59C85 44 79 21 79 16C79-2 93-11 108-11C120-11 138-3 145 17C146 19 158 66 164 91L186 181C192 203 198 225 203 248L216 298C231 329 284 420 379 420C424 420 433 383 433 350C433 288 384 160 368 117C359 94 358 82 358 71C358 24 393-11 440-11C534-11 571 135 571 143Z"></path></g></g><g data-mml-node="mo" transform="translate(8721.2,0)"><path data-c="29" d="M288 208L288 292C288 463 183 663 73 746C71 747 69 748 67 748C62 748 57 743 57 738C57 735 59 732 61 730C165 652 234 452 234 292L234 208C234 48 165-152 61-230C59-232 57-235 57-238C57-243 62-248 67-248C69-248 71-247 73-246C183-163 288 37 288 208Z"></path></g><g data-mml-node="mo" transform="translate(9332.4,0)"><path data-c="2B" d="M722 250C722 261 713 270 702 270L409 270L409 563C409 574 400 583 389 583C378 583 369 574 369 563L369 270L76 270C65 270 56 261 56 250C56 239 65 230 76 230L369 230L369-63C369-74 378-83 389-83C400-83 409-74 409-63L409 230L702 230C713 230 722 239 722 250Z"></path></g><g data-mml-node="msub" transform="translate(10332.7,0)"><g data-mml-node="mi"><path data-c="1D465" d="M527 376C527 428 468 442 434 442C376 442 341 389 329 366C304 432 250 442 221 442C117 442 60 313 60 288C60 278 72 278 72 278C80 278 83 280 85 289C119 395 185 420 219 420C238 420 273 411 273 353C273 322 256 255 219 115C203 53 168 11 124 11C118 11 95 11 74 24C99 29 121 50 121 78C121 105 99 113 84 113C54 113 29 87 29 55C29 9 79-11 123-11C189-11 225 59 228 65C240 28 276-11 336-11C439-11 496 118 496 143C496 153 487 153 484 153C475 153 473 149 471 142C438 35 370 11 338 11C299 11 283 43 283 77C283 99 289 121 300 165L334 302C340 328 363 420 433 420C438 420 462 420 483 407C455 402 435 377 435 353C435 337 446 318 473 318C495 318 527 336 527 376Z"></path></g><g data-mml-node="TeXAtom" transform="translate(605,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D45B" d="M571 143C571 153 562 153 559 153C549 153 549 150 544 135C524 67 491 11 442 11C425 11 418 21 418 44C418 69 427 93 436 115C455 168 497 278 497 335C497 402 454 442 382 442C292 442 243 378 226 355C221 411 180 442 134 442C88 442 69 403 59 385C43 351 29 292 29 288C29 278 41 278 41 278C51 278 52 279 58 301C75 372 95 420 131 420C151 420 162 407 162 374C162 353 159 342 146 290L88 59C85 44 79 21 79 16C79-2 93-11 108-11C120-11 138-3 145 17C146 19 158 66 164 91L186 181C192 203 198 225 203 248L216 298C231 329 284 420 379 420C424 420 433 383 433 350C433 288 384 160 368 117C359 94 358 82 358 71C358 24 393-11 440-11C534-11 571 135 571 143Z"></path></g><g data-mml-node="mo" transform="translate(600,0)"><path data-c="2B" d="M722 250C722 261 713 270 702 270L409 270L409 563C409 574 400 583 389 583C378 583 369 574 369 563L369 270L76 270C65 270 56 261 56 250C56 239 65 230 76 230L369 230L369-63C369-74 378-83 389-83C400-83 409-74 409-63L409 230L702 230C713 230 722 239 722 250Z"></path></g><g data-mml-node="mn" transform="translate(1378,0)"><path data-c="31" d="M419 0L419 31L387 31C297 31 294 42 294 79L294 640C294 664 294 666 271 666C209 602 121 602 89 602L89 571C109 571 168 571 220 597L220 79C220 43 217 31 127 31L95 31L95 0C130 3 217 3 257 3C297 3 384 3 419 0Z"></path></g></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="block"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><mtext>Â </mtext><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mrow data-mjx-texclass="ORD"><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub><mo stretchy="false">)</mo><mo>=</mo><mn>31</mn><mo>â‹…</mo><mi>f</mi><mo stretchy="false">(</mo><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="false">)</mo><mo>+</mo><msub><mi>x</mi><mrow data-mjx-texclass="ORD"><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msub></math></mjx-assistive-mml></mjx-container><p>n æ˜¯è¿­ä»£æ¬¡æ•°ï¼Œ<mjx-container class="MathJax" jax="SVG" overflow="overflow" style="position:relative;"><svg style="vertical-align:-0.357ex;" xmlns="http://www.w3.org/2000/svg" width="2.442ex" height="1.357ex" role="img" focusable="false" viewBox="0 -442 1079.3 599.8" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D465" d="M527 376C527 428 468 442 434 442C376 442 341 389 329 366C304 432 250 442 221 442C117 442 60 313 60 288C60 278 72 278 72 278C80 278 83 280 85 289C119 395 185 420 219 420C238 420 273 411 273 353C273 322 256 255 219 115C203 53 168 11 124 11C118 11 95 11 74 24C99 29 121 50 121 78C121 105 99 113 84 113C54 113 29 87 29 55C29 9 79-11 123-11C189-11 225 59 228 65C240 28 276-11 336-11C439-11 496 118 496 143C496 153 487 153 484 153C475 153 473 149 471 142C438 35 370 11 338 11C299 11 283 43 283 77C283 99 289 121 300 165L334 302C340 328 363 420 433 420C438 420 462 420 483 407C455 402 435 377 435 353C435 337 446 318 473 318C495 318 527 336 527 376Z"></path></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D45B" d="M571 143C571 153 562 153 559 153C549 153 549 150 544 135C524 67 491 11 442 11C425 11 418 21 418 44C418 69 427 93 436 115C455 168 497 278 497 335C497 402 454 442 382 442C292 442 243 378 226 355C221 411 180 442 134 442C88 442 69 403 59 385C43 351 29 292 29 288C29 278 41 278 41 278C51 278 52 279 58 301C75 372 95 420 131 420C151 420 162 407 162 374C162 353 159 342 146 290L88 59C85 44 79 21 79 16C79-2 93-11 108-11C120-11 138-3 145 17C146 19 158 66 164 91L186 181C192 203 198 225 203 248L216 298C231 329 284 420 379 420C424 420 433 383 433 350C433 288 384 160 368 117C359 94 358 82 358 71C358 24 393-11 440-11C534-11 571 135 571 143Z"></path></g></g></g></g></svg><mjx-assistive-mml unselectable="on" display="inline"><math xmlns="http://www.w3.org/1998/Math/MathML"><msub><mi>x</mi><mi>n</mi></msub></math></mjx-assistive-mml></mjx-container> æ˜¯å˜é‡ï¼Œéœ€è¦è®¡ç®—å‡ æ¬¡å°±è¿­ä»£å‡ æ¬¡</p><p>é¡ºä¾¿æä¸€å¥ï¼Œçœ‹åˆ° Override hashCode() å’Œ equals()ï¼Œé‚£ä¹ˆå¤§æ¦‚ç‡ä»–æ˜¯è¦åœ¨æŸä¸ªæ•°æ®è¡¨é‡Œä½œä¸º key ä½¿ç”¨äº†ã€‚</p></li><li><p>DefaultMQPushConsumerImpl::pullMessage</p><p>è¿™ä¸ªæ–¹æ³•ä¹Ÿå¾ˆé•¿ï¼Œè€æ ·å­åˆ å‡ï¼Œåªçœ‹ä¸»è¦é€»è¾‘ï¼Œè¿™é‡Œæˆ‘æŠŠ pullMessage çš„ä»£ç åˆ†æˆäº†ä¸‰ä¸ªéƒ¨åˆ†ã€‚ å‰é¢æ§æµçš„éƒ¨åˆ†å¯ä»¥ä¸çœ‹ï¼Œä¸­é—´ callback è¦çœ‹ä¸€ä¸‹ï¼Œæ ¸å¿ƒå†…å®¹åœ¨ç¬¬ä¸‰æ®µã€‚</p><p>ä¸‹é¢æ§æµè¿™ä¸€æ®µå¯ä»¥ä¸çœ‹ï¼Œå¯å…¨éƒ¨è·³è¿‡ã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// DefaultMQPushConsumerImpl::pullMessage</span>
<span class="token comment">// get ProcessQueue</span>
<span class="token keyword">final</span> <span class="token class-name">ProcessQueue</span> processQueue <span class="token operator">=</span> pullRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// æ§æµ</span>
<span class="token comment">// æœ¬åœ°ç¼“å­˜æ¶ˆæ¯æ•°é‡ processQueue.getMsgCount &gt; 1000 è§¦å‘æ§æµ</span>
<span class="token comment">// é—´éš”ä¸º PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL = 50ms</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedMessageCount <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullThresholdForQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// æ§æµçš„å¤„ç†æ–¹å¼å°±æ˜¯å‰é¢è´´è¿‡çš„ PullMessageService().executePullRequestLater</span>
   <span class="token comment">// å®é™…ä¸Šå°±æ˜¯æŠŠ pullRequest é‡æ–° put å› pullRequestQueue</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestLater</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">,</span> <span class="token constant">PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// log ...</span>
   <span class="token comment">// ç„¶åç›´æ¥ return</span>
   <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">// æœ¬åœ°ç¼“å­˜æ¶ˆæ¯ &gt; 100 Mb è§¦å‘æ§æµ</span>
 <span class="token comment">// å¤„ç†æ–¹å¼åŒä¸Š ä»£ç ç•¥</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedMessageSizeInMiB <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullThresholdSizeForQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>

 <span class="token comment">// å¹¶å‘æ¶ˆè´¹æ§æµ</span>
 <span class="token comment">// maxSpan &gt; 2000 å¤„ç†æ–¹å¼åŒä¸Š</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>processQueue<span class="token punctuation">.</span><span class="token function">getMaxSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumeConcurrentlyMaxSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>

 <span class="token comment">// é¡ºåºæ¶ˆè´¹</span>
 <span class="token comment">// ä¸ç®—æ˜¯æ§æµã€ä¸è¿‡å¤„ç†æ–¹å¼ä¸€æ ·  </span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>processQueue<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// pullRequest.isPreviouslyLocked é»˜è®¤ä¸º false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pullRequest<span class="token punctuation">.</span><span class="token function">isPreviouslyLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// é¦–æ¬¡ pullMessage ä¼šè¿›å…¥è¿™é‡Œ</span>
        <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// æ ¹æ®é»˜è®¤çš„åˆå§‹æ¶ˆè´¹ä½ç‚¹ï¼ˆè§åŸºç¡€æ¦‚å¿µ-æ¶ˆè´¹ä½ç‚¹éƒ¨åˆ†ï¼‰ è®¡ç®—å®é™…æ¶ˆè´¹ä½ç‚¹</span>
          <span class="token comment">// è¿™ä¸ªå¯ä»¥è‡ªå·±å»çœ‹ä»£ç ï¼Œæˆ–è€…çœ‹ä¹¦ä¹Ÿè¡Œ</span>
            offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">computePullFromWhereWithException</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestLater</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">,</span> pullTimeDelayMillsWhenException<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to compute pull offset, pullResult: {}&quot;</span><span class="token punctuation">,</span> pullRequest<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// broker å¼‚å¸¸ or readFile å¼‚å¸¸æ—¶ä¼šä¸º trueï¼Œä¹Ÿå°±æ˜¯ offset ä¸º -1</span>
        <span class="token comment">// offset å¦‚æœæ­£å¸¸ä¼šåé¢ä¼šè®¾ç½®ä¸º pullRequest.nextOffset çš„å€¼</span>
        <span class="token keyword">boolean</span> brokerBusy <span class="token operator">=</span> offset <span class="token operator">&lt;</span> pullRequest<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;the first time to pull message, so fix offset from broker. pullRequest: {} NewOffset: {} brokerBusy: {}&quot;</span><span class="token punctuation">,</span>
            pullRequest<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> brokerBusy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerBusy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: {} NewOffset: {}&quot;</span><span class="token punctuation">,</span>
                pullRequest<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pullRequest<span class="token punctuation">.</span><span class="token function">setPreviouslyLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// pullTimeDelayMillsWhenException é»˜è®¤ 3000ms</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestLater</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">,</span> pullTimeDelayMillsWhenException<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;pull message later because not locked in broker, {}&quot;</span><span class="token punctuation">,</span> pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åæ¥çœ‹ç¬¬äºŒéƒ¨åˆ†ï¼Œä¸€ä¸ªè€é•¿çš„ callbackï¼Œä¸»è¦çœ‹ onSuccess æ–¹æ³•ï¼Œå®ƒæ˜¯ç»™ consumer å‘èµ·å¼‚æ­¥è¯·æ±‚æˆåŠŸæ—¶ç”¨çš„ã€‚ä¸»è¦åŠŸèƒ½å°±æ˜¯æŠŠæ‹‰å›æ¥çš„æ•°æ®è§£ç ä¸º msgList ç„¶åå­˜å…¥ msgTreeMap ä»¥ä¾¿æ¶ˆè´¹ï¼Œæœ€åè°ƒç”¨ consumeMessageService.submitConsumeRequest æäº¤å¤åˆ¶æ¶ˆè´¹çš„æ‰§è¡Œå™¨æ‰§è¡Œã€‚</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// DefaultMQPushConsumerImpl::pullMessage  </span>

<span class="token class-name">PullCallback</span> pullCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PullCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">PullResult</span> pullResult<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// å¯¹ä» broker ä¸Šæ‹‰å›æ¥çš„æ¶ˆæ¯è¿›è¡Œè§£ç è¿‡æ»¤ç­‰å¤„ç†ã€‚</span>
    pullResult <span class="token operator">=</span> <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>pullAPIWrapper<span class="token punctuation">.</span><span class="token function">processPullResult</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pullResult<span class="token punctuation">,</span>
        subscriptionData<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getPullStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">FOUND</span><span class="token operator">:</span> <span class="token comment">// FOUND å°±æ˜¯ä»£è¡¨ ä» Broker æ‹‰å›äº†æ–°æ¶ˆæ¯</span>
            <span class="token keyword">long</span> prevRequestOffset <span class="token operator">=</span> pullRequest<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// çŠ¶æ€ä¿¡æ¯çš„å¤„ç† ç•¥ ...</span>

            <span class="token keyword">long</span> firstMsgOffset <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
            <span class="token comment">// MsgFoundList ä¸ºç©ºï¼Œç«‹åˆ»å†æäº¤ä¸€ä¸ª pullRequest åˆ°é˜Ÿåˆ—ä¸­</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// æ‹‰å›çš„ç¬¬ä¸€æ¡æ¶ˆæ¯çš„ offset</span>
                firstMsgOffset <span class="token operator">=</span> pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// çŠ¶æ€å¤„ç†ï¼Œç•¥</span>

                <span class="token comment">// å°±æ˜¯å­˜å…¥ msgTreeMap ï¼Œé¡ºä¾¿åŒæ­¥ç»´æŠ¤ ProcessQueue çš„å±æ€§</span>
                <span class="token comment">// åªè¦ msgTreeMap ä¸ä¸ºç©ºï¼Œä¸” ProcessQueue ä¸å¤„äº æ¶ˆè´¹ä¸­çš„çŠ¶æ€ï¼Œå°±è¿”å› true</span>
                <span class="token comment">// å…¶ä»–æƒ…å†µåˆ™è¿”å› false</span>
                <span class="token keyword">boolean</span> dispatchToConsume <span class="token operator">=</span> processQueue<span class="token punctuation">.</span><span class="token function">putMessage</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// ç„¶åå°±æ¥åˆ°äº† consumeMessageService.submitConsumeRequest</span>
                <span class="token comment">// ä¹Ÿå°±æ˜¯å‰æ–‡è®²çš„ åˆ›å»º ConsumeRequest å¹¶æäº¤ç»™ consumeExecutor å»æ‰§è¡Œã€‚</span>
                <span class="token comment">// è¿™æ–¹æ³•æœ‰ä¸¤ç§å®ç°ï¼Œé¡ºåºæ¶ˆè´¹/å¹¶å‘æ¶ˆè´¹</span>
                <span class="token comment">// dispatchToConsume å‚æ•°ä»…ä½œç”¨äºé¡ºåºæ¶ˆè´¹ï¼Œå¦‚æœæ˜¯ false åˆ™ä¸ä¼šæ‰§è¡Œ</span>
                <span class="token comment">// å¹¶å‘æ¶ˆè´¹æ— æ‰€è°“é¡ºåºï¼Œæ‰€ä»¥ dispatchToConsume å‚æ•°å°±æ²¡å•¥ç”¨</span>
                <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumeMessageService<span class="token punctuation">.</span><span class="token function">submitConsumeRequest</span><span class="token punctuation">(</span>
                    pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    processQueue<span class="token punctuation">,</span>
                    pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dispatchToConsume<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// è¿™ä¸ª PullInterval æ‹‰å–é—´éš”é»˜è®¤æ˜¯0 ï¼Œå¦‚æœå¤§äº0äº†è‡ªç„¶å°±æ˜¯ç­‰ä¼šå„¿å†å»æ‹‰å–ã€‚</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestLater</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">,</span>
                        <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// PullInterval == 0 å°±ç«‹å³æ‹‰å–</span>
                    <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> prevRequestOffset
                <span class="token operator">||</span> firstMsgOffset <span class="token operator">&lt;</span> prevRequestOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;[BUG] pull message result maybe data wrong, nextBeginOffset: {} firstMsgOffset: {} prevRequestOffset: {}&quot;</span><span class="token punctuation">,</span>
                    pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    firstMsgOffset<span class="token punctuation">,</span>
                    prevRequestOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">NO_NEW_MSG</span><span class="token operator">:</span> <span class="token comment">// æ²¡æœ‰æ–°æ¶ˆæ¯</span>
        <span class="token keyword">case</span> <span class="token constant">NO_MATCHED_MSG</span><span class="token operator">:</span> <span class="token comment">// æ²¡æœ‰åŒ¹é…çš„æ¶ˆæ¯</span>
            pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// æ›´æ–° offset,æœ¬åœ° or local ä¸¤ç§æ–¹å¼</span>
            <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">correctTagsOffset</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">OFFSET_ILLEGAL</span><span class="token operator">:</span> <span class="token comment">// åç§»é‡éæ³•</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;the pull request offset illegal, {} {}&quot;</span><span class="token punctuation">,</span>
                pullRequest<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pullResult<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pullRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDropped</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeTaskLater</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token comment">// é‡æ–°è®¡ç®—å¹¶æ›´æ–°åç§»é‡ï¼Œç§»é™¤å½“å‰ processQueue</span>
                    <span class="token comment">// è¿™éƒ¨åˆ†å°±ä¸å±•å¼€äº†</span>
                    <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore<span class="token punctuation">.</span><span class="token function">updateOffset</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pullRequest<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">removeProcessQueue</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;fix the pull request offset, {}&quot;</span><span class="token punctuation">,</span> pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;executeTaskLater Exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€åæ˜¯ç¬¬ä¸‰éƒ¨åˆ†ï¼Œå¯¹ broker å‘èµ·æ‹‰å–æ¶ˆæ¯è¯·æ±‚ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// 3rd part</span>
  <span class="token keyword">boolean</span> commitOffsetEnable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> commitOffsetValue <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
  <span class="token comment">// è¯»å–æ¶ˆè´¹ä½ç‚¹ï¼Œåˆ†é¡ºåº/é›†ç¾¤ä¸¤ç§å®ç°ï¼Œä¸è¿‡é›†ç¾¤ä¹Ÿæ˜¯ä»æœ¬åœ°å†…å­˜é‡Œè¯»</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span><span class="token constant">CLUSTERING</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      commitOffsetValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore<span class="token punctuation">.</span><span class="token function">readOffset</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ReadOffsetType</span><span class="token punctuation">.</span><span class="token constant">READ_FROM_MEMORY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>commitOffsetValue <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          commitOffsetEnable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">String</span> subExpression <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">boolean</span> classFilter <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// ä» rebalanceImpl ä¸­æ ¹æ® topic æ‹¿åˆ°è®¢é˜…æ•°æ®</span>
  <span class="token class-name">SubscriptionData</span> sd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">getSubscriptionInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// isPostSubscriptionWhenPull æ˜¯å¦æ¯æ¬¡ pull çš„æ—¶å€™éƒ½æ›´æ–°è®¢é˜…å…³ç³» ï¼Œé»˜è®¤ false</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">isPostSubscriptionWhenPull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sd<span class="token punctuation">.</span><span class="token function">isClassFilterMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          subExpression <span class="token operator">=</span> sd<span class="token punctuation">.</span><span class="token function">getSubString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      classFilter <span class="token operator">=</span> sd<span class="token punctuation">.</span><span class="token function">isClassFilterMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> sysFlag <span class="token operator">=</span> <span class="token class-name">PullSysFlag</span><span class="token punctuation">.</span><span class="token function">buildSysFlag</span><span class="token punctuation">(</span>
      commitOffsetEnable<span class="token punctuation">,</span> <span class="token comment">// commitOffset</span>
      <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// suspend</span>
      subExpression <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// subscription</span>
      classFilter <span class="token comment">// class filter</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// æœ€å netty client å‘èµ·æ‹‰æ¶ˆæ¯çš„è¯·æ±‚ï¼Œè¿™å°±ä¸å±•å¼€äº†</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pullAPIWrapper<span class="token punctuation">.</span><span class="token function">pullKernelImpl</span><span class="token punctuation">(</span>
          pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          subExpression<span class="token punctuation">,</span>
          subscriptionData<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          subscriptionData<span class="token punctuation">.</span><span class="token function">getSubVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          pullRequest<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          sysFlag<span class="token punctuation">,</span>
          commitOffsetValue<span class="token punctuation">,</span>
          <span class="token constant">BROKER_SUSPEND_MAX_TIME_MILLIS</span><span class="token punctuation">,</span>
          <span class="token constant">CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND</span><span class="token punctuation">,</span>
          <span class="token class-name">CommunicationMode</span><span class="token punctuation">.</span><span class="token constant">ASYNC</span><span class="token punctuation">,</span>
          pullCallback
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;pullKernelImpl exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestLater</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">,</span> pullTimeDelayMillsWhenException<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><h3 id="è´Ÿè½½å‡è¡¡" tabindex="-1"><a class="header-anchor" href="#è´Ÿè½½å‡è¡¡"><span>è´Ÿè½½å‡è¡¡</span></a></h3><p>rebalance è¿™ä¸€å±‚ä»ç†è®ºæ¨¡å‹è§’åº¦çœ‹æ˜¯åŠ åœ¨æ¶ˆè´¹è¡Œä¸ºä¹‹å‰çš„ï¼Œä¸»è¦é’ˆå¯¹é›†ç¾¤æ¶ˆè´¹æ¨¡å¼ã€‚</p><p>å®é™…å®ç°æ–¹å¼æ˜¯ï¼Œè´Ÿè½½å‡è¡¡å™¨æ¯éš” 20s å¯¹è¿œç¨‹ Queue ä¸Šé”ï¼Œç„¶åæ‰§è¡Œ doRebalanceï¼Œæœ€åé‡Šæ”¾é”ã€‚</p><p>æ¢å¥è¯è¯´å°±æ˜¯æ¶ˆè´¹ç»„å†…çš„æ¯ä¸ª consumer éƒ½åªç®¡ä» processQueue ä¸­å–å‡ºæ¶ˆæ¯è¿›è¡Œæ¶ˆè´¹ï¼Œè€Œè´Ÿè½½å‡è¡¡å™¨åˆ™åˆ©ç”¨åˆ†é…ç­–ç•¥ä¸º consumer åˆ†é…ä»–åº”è¯¥æ¶ˆè´¹å“ªäº›æ¶ˆæ¯ã€‚</p><ul><li>åŸºæœ¬ç»„æˆ</li></ul><p><code>RebalanceImpl</code> æ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œæœ‰ä¸‰ä¸ªå­ç±»ï¼Œ<code>RebalanceLitePullImpl</code>ï¼Œ<code>RebalancePullImpl</code>ï¼Œ<code>RebalancePushImpl</code>ã€‚ å¾ˆæ˜æ˜¾å°±æ˜¯å¯¹åº”ä¸‰ç§ consumer å®ç°ç±»ã€‚ ä»¥ Push æ¨¡å¼ä¸ºä¾‹ï¼Œè´Ÿè½½å‡è¡¡å™¨å†…éƒ¨ç»´æŠ¤å¦‚ä¸‹ä¸‰ä¸ªæ•°æ®è¡¨ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">,</span> <span class="token class-name">ProcessQueue</span><span class="token punctuation">&gt;</span></span> processQueueTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">,</span> <span class="token class-name">ProcessQueue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* topic */</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> topicSubscribeInfoTable <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span> <span class="token comment">/* topic */</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token operator">&gt;</span> subscriptionInner <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å››æ¡å±æ€§ï¼Œåœ¨ consumer å¯åŠ¨é˜¶æ®µåˆå§‹åŒ–ï¼ˆå®é™…ä¸Š subscriptionInner ä¹Ÿä¼šåˆå§‹åŒ–ï¼‰ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setConsumerGroup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setAllocateMessageQueueStrategy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getAllocateMessageQueueStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setmQClientFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ„é€ æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">RebalancePushImpl</span><span class="token punctuation">(</span><span class="token class-name">DefaultMQPushConsumerImpl</span> defaultMQPushConsumerImpl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> defaultMQPushConsumerImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è´Ÿè½½å‡è¡¡çš„å®ç°å’Œ consumer çš„å®ç°è¦å¯¹åº”ã€‚</p><p>å»¶è¿Ÿè§£é”çš„å€¼é»˜è®¤ä¸º 20sï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨è¿œç¨‹ä¸Šé”çš„å‘¨æœŸï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token constant">UNLOCK_DELAY_TIME_MILLS</span> <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;rocketmq.client.unlockDelayTimeMills&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;20000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>è´Ÿè´£æ‰§è¡Œè´Ÿè½½å‡è¡¡ä»»åŠ¡çš„æ˜¯ <code>RebalanceService</code>ã€‚</p><p>å®ƒçš„å·¥ä½œå°±æ˜¯ 20s æ‰§è¡Œä¸€æ¬¡è´Ÿè½½å‡è¡¡ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// RebalanceService::run</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span>waitInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>mqClientFactory<span class="token punctuation">.</span><span class="token function">doRebalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>è´Ÿè½½å‡è¡¡æ“ä½œ RebalanceImpl::doRebalance</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// RebalanceImpl::doRebalance  </span>

<span class="token comment">// isOder åœ¨ Pull æ¨¡å¼ä¸º falseï¼ŒPush æ¨¡å¼æ ¹æ® consumer.isConsumeOrderly åˆ¤æ–­</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doRebalance</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> isOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token punctuation">&gt;</span></span> subTable <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSubscriptionInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subTable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> subTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> topic <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// this one</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rebalanceByTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> isOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>topic<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token constant">RETRY_GROUP_TOPIC_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;rebalanceByTopic Exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ä» processQueueTable ä¸­å‰”é™¤è®¢é˜…å…³ç³»é”™è¯¯çš„æ¶ˆæ¯</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">truncateMessageQueueNotMyTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç„¶åæ¥çœ‹ <code>RebalanceImpl::rebalanceByTopic</code>ï¼š</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">rebalanceByTopic</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">switch</span> <span class="token punctuation">(</span>messageModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">case</span> <span class="token constant">BROADCASTING</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// å¹¿æ’­æ¨¡å¼è·Ÿè´Ÿè½½å‡è¡¡è¿™ä¸ªæ¦‚å¿µå…¶å®æ²¡å•¥å…³ç³»</span>
              <span class="token comment">// ç•¥ ...</span>
             <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">case</span> <span class="token constant">CLUSTERING</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// ä¸»è¦çœ‹é›†ç¾¤æ¨¡å¼  </span>
           <span class="token comment">// topic ä¸‹çš„ MessageQueue é›†åˆ</span>
             <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqSet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topicSubscribeInfoTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment">// cidAll å°±æ˜¯ topic å¯¹åº”çš„ æ¶ˆè´¹ç»„ä¸‹çš„æ‰€æœ‰ consumer çš„ id åˆ—è¡¨</span>
             <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cidAll <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">findConsumerIdList</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> consumerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> mqSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>topic<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token constant">RETRY_GROUP_TOPIC_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;doRebalance, {}, but the topic[{}] not exist.&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> cidAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;doRebalance, {} {}, get consumer id list failed&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>

             <span class="token keyword">if</span> <span class="token punctuation">(</span>mqSet <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cidAll <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqAll <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 mqAll<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>mqSet<span class="token punctuation">)</span><span class="token punctuation">;</span>

                 <span class="token comment">// æ’åºï¼Œä¿è¯æ¯ä¸ª consumer ä¸Šéƒ½æ˜¯ä¸€è‡´çš„ã€‚</span>
                 <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>mqAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>

                 <span class="token class-name">AllocateMessageQueueStrategy</span> strategy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMessageQueueStrategy<span class="token punctuation">;</span>

                 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> allocateResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                 <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// æ ¹æ®ä¸åŒç­–ç•¥æ¥åˆ†é…</span>
                     allocateResult <span class="token operator">=</span> strategy<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>
                         <span class="token keyword">this</span><span class="token punctuation">.</span>consumerGroup<span class="token punctuation">,</span>
                         <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         mqAll<span class="token punctuation">,</span>
                         cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName={}&quot;</span><span class="token punctuation">,</span> strategy<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">return</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>

                 <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> allocateResultSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>allocateResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     allocateResultSet<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>allocateResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
                 <span class="token comment">// éå† processQueueTableï¼Œæ ¹æ® allocateResultSet å‰”é™¤æ— æ•ˆé˜Ÿåˆ—ï¼Œæ·»åŠ æ–°é˜Ÿåˆ—å¤±è´¥æ—¶ï¼Œé‡æ–°è®¡ç®—æ¶ˆè´¹ä½ç‚¹å¹¶é‡æ‹‰æ¶ˆæ¯ã€‚</span>
                 <span class="token comment">// åªè¦å¯¹ processQueueTable è¿›è¡Œä¿®æ”¹å°±ä¼šè¿”å› true ï¼Œnothing touched return false</span>
                 <span class="token comment">// é€šå¸¸æ˜¯æ¶ˆè´¹ç»„å†…çš„ consumer æ•°é‡å‘ç”Ÿå˜åŒ–ï¼Œç„¶åè´Ÿè½½å‡è¡¡å™¨å°±è¦ç»™ consumer é‡æ–°è®¡ç®—å®ƒç°åœ¨è¦è´Ÿè½½æ¶ˆè´¹å“ªä¸ªé˜Ÿåˆ—</span>
                 <span class="token keyword">boolean</span> changed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateProcessQueueTableInRebalance</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> allocateResultSet<span class="token punctuation">,</span> isOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>changed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
                         <span class="token string">&quot;rebalanced result changed. allocateMessageQueueStrategyName={}, group={}, topic={}, clientId={}, mqAllSize={}, cidAllSize={}, rebalanceResultSize={}, rebalanceResultSet={}&quot;</span><span class="token punctuation">,</span>
                         strategy<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mqSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cidAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         allocateResultSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allocateResultSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">messageQueueChanged</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> mqSet<span class="token punctuation">,</span> allocateResultSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
             <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">default</span><span class="token operator">:</span>
             <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°å¹¿æ’­æ¨¡å¼å°±æ˜¯ç›´æ¥æ‰§è¡Œ <code>updateProcessQueueTableInRebalance</code>ï¼Œé›†ç¾¤æ¨¡å¼åˆ™æ˜¯å…ˆæ‰§è¡Œ rebalanceï¼Œç„¶åå†æ‰§è¡Œ <code>updateProcessQueueTableInRebalance</code>ã€‚ è¯´ç™½äº†å¹¿æ’­æ¨¡å¼ä¸å­˜åœ¨è´Ÿè½½å‡è¡¡è¿™ä¸ªæ¦‚å¿µã€‚</p><ul><li><p>AllocateMessageQueueStrategy è´Ÿè½½å‡è¡¡ç­–ç•¥</p><p>ç›®å‰ä¸€å…±å…­ç§è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé»˜è®¤çš„æ˜¯ <code>AllocateMessageQueueAveragely</code>ï¼Œè¿™é‡Œå°±ä¸ç½—åˆ—äº†ï¼Œæœ‰å…´è¶£å¯ä»¥è‡ªå·±å»çœ‹ã€‚é¡ºä¾¿è‡ªè¡Œæ¢ç´¢ä¸ºä»€ä¹ˆæ–‡æ¡£å’Œæœ€ä½³å®è·µéƒ½å»ºè®®æ¶ˆè´¹è€…æ•°é‡è¦æ¯”é˜Ÿåˆ—æ•°é‡å°‘ã€‚</p></li><li><p>æ€»ç»“</p><p>å¯ä»¥çœ‹å‡ºï¼Œrebalance æ˜¯ä¸€ä¸ªé›†ç¾¤æ¨¡å¼ä¸‹çš„ï¼ŒåŸºäºé˜Ÿåˆ—å’Œæ¶ˆè´¹è€…æ•°é‡çš„è´Ÿè½½å‡è¡¡ã€‚ å®ƒæŠŠé˜Ÿåˆ—å’Œæ¶ˆè´¹è€…è¿›è¡Œäº†ä¸€å¯¹ä¸€æ˜ å°„ï¼Œç„¶åæ¯ä¸ªæ¶ˆè´¹è€…æŒ‰ pullMsg --&gt; æäº¤æ¶ˆè´¹ä½ç‚¹ --&gt; æŒä¹…åŒ–æ¶ˆè´¹ä½ç‚¹çš„æµç¨‹å¤„ç†æ¶ˆæ¯ï¼ŒpullMsg æ—¶ä¸æäº¤æ¶ˆè´¹çŠ¶æ€ã€‚ ä¸ºäº†é¿å…æ¶ˆæ¯è¢«å¤šä¸ªæ¶ˆè´¹è€…é‡å¤æ¶ˆè´¹ï¼Œæ¯ä¸ªé˜Ÿåˆ—ä»…è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹ã€‚</p><p>å¹¶ä¸”è¦æ³¨æ„ï¼Œç”±äº rebalance æ˜¯å•ç‹¬ä¸€ä¸ªçº¿ç¨‹æ¯ 20s è¿›è¡Œä¸€æ¬¡åˆ†é…ï¼Œå½“é˜Ÿåˆ—æ•°ã€æ¶ˆè´¹è€…æ•°å‘ç”Ÿå˜åŒ–æ—¶ï¼Œé‡å¤æ¶ˆè´¹æ˜¯æœ‰å¯èƒ½å‘ç”Ÿçš„ã€‚</p><p>æ³¨æ„è¿™é‡Œéƒ½æ˜¯ 4.x ç‰ˆæœ¬ï¼Œ5.x ç‰ˆæœ¬è´Ÿè½½å‡è¡¡è¿™å—æœ‰é‡æ„ï¼Œè€Œä¸”æä¾›äº†æ¶ˆæ¯ç²’åº¦çš„è´Ÿè½½å‡è¡¡ã€‚</p></li></ul><h3 id="æ¶ˆæ¯ç¡®è®¤" tabindex="-1"><a class="header-anchor" href="#æ¶ˆæ¯ç¡®è®¤"><span>æ¶ˆæ¯ç¡®è®¤</span></a></h3><p>æ— è®ºæ˜¯æ¶ˆè´¹æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œäº¦æˆ–è€…å…¶ä»–æƒ…å†µï¼Œconsumer éƒ½ä¼šæœ‰â€œæ¶ˆè´¹ç»“æœâ€ï¼Œæ ¹æ®æ¶ˆè´¹ç»“æœçŠ¶æ€çš„ä¸åŒï¼Œconsumer ä¼šè¿›è¡Œä¸ä¸€æ ·çš„å¤„ç†ï¼ˆè§ <code>consumer.processConsumeResult()</code>ï¼‰ï¼Œæ¯”å¦‚ <code>RECONSUME_LATER</code> å°±ä¼šæŠŠæ¶ˆæ¯å‘å› broker ä»è€Œå»¶è¿Ÿæ¶ˆè´¹ã€‚è¿™ä¸ªæµç¨‹å«æ¶ˆæ¯ç¡®è®¤ï¼Œæˆ– SendMsgBackï¼Œæˆ– ack æ¶ˆæ¯ã€‚</p><p>è¿™éƒ¨åˆ†ä»£ç å°±ä¸å±•å¼€åˆ†æäº†ï¼Œæœ¬è´¨å°±æ˜¯ netty client ç»™ netty server å‘è¯·æ±‚ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ <code>MQClientAPIImpl::consumerSendMessageBack</code> æ–¹æ³•ï¼Œè¯·æ±‚ç ä¸º <code>RequestCode.CONSUMER_SEND_MSG_BACK</code>ï¼Œç„¶åæŒ‰ç…§ rocketmq è‡ªå®šä¹‰çš„è¯·æ±‚åè®®å°è£…å¥½ requestHeaderã€bodyï¼Œencodeï¼Œå‘é€è¯·æ±‚ã€‚ ç„¶åå‘é€è¯·æ±‚ä¾ç„¶æ˜¯æœ‰åŒæ­¥å¼‚æ­¥ä¸¤ç§æ–¹å¼ï¼Œä¸å†èµ˜è¿°ã€‚</p><p>ç»†èŠ‚éƒ¨åˆ†å¦‚æœæœ‰å…´è¶£ï¼Œä¸€æ–¹é¢ä½ å¯ä»¥å»æŸ¥ä¹¦ (ã€ŠRocketMQ æŠ€æœ¯å†…å¹•ã€‹)ï¼Œå¦ä¸€æ–¹é¢ä½ å¯ä»¥å»çœ‹å†…éƒ¨åè®®çš„å®ç°ï¼Œä¸ªäººå»ºè®®ä¸¤ç§æ–¹å¼ç»“åˆï¼Œæ¯•ç«Ÿç¼ºä¹æ³¨é‡Šå’Œç»†èŠ‚æ–‡æ¡£çš„ä»£ç æœ‰ä¸ªå‚è€ƒä¹¦è¿˜æ˜¯å¥½çš„ã€‚</p><h2 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“</span></a></h2><p>æ¶ˆæ¯æ¶ˆè´¹å°±åˆ°è¿™é‡Œç»“æŸå•¦ï¼Œå·²ç»å¤ªé•¿äº†ï¼Œåˆä¸æ˜¯å†™ä¹¦ã€‚æ²¡æœ‰ç‰¹æ„è®²è§£ pull æ¨¡å¼å’Œå¹¶å‘æ¶ˆè´¹çš„æµç¨‹ï¼Œä¸è¿‡å¤§åŒå°å¼‚ã€‚æ¯”å¦‚ Pull æ¨¡å¼çš„ consumer å®ç°ï¼Œå“ªæ€•ä½ ä¸å»çœ‹ä»£ç ç°åœ¨ä¹Ÿåº”è¯¥èƒ½æ¨æµ‹å‡ºæ¥ï¼Œå®ƒè·Ÿ <code>DefaultMQPushConsumer</code> çš„åŒºåˆ«å°±æ˜¯å®ƒæ˜¯è‡ªå·±ä¸»åŠ¨å»æ‹‰å–æ¶ˆæ¯ï¼Œæ¢å¥è¯è¯´å®ƒä¸éœ€è¦ <code>PullMessageService</code>ï¼Œå…¶ä»–å‡ ä¹éƒ½ä¸€æ ·ã€‚<code>ConsumeMessageConcurrentlyService</code> ä¹Ÿæ˜¯åŒç†ï¼Œå®ƒä¸éœ€è¦ä¿è¯é¡ºåºï¼Œæ‰€ä»¥ç›´æ¥æ¶ˆè´¹å°±å¯ä»¥äº†ï¼Œä¸éœ€è¦åƒé¡ºåºæ¶ˆè´¹ä¸€æ ·ä» consumingMsgOrderlyTreeMap é‡Œä¸€ä¸ªä¸ªå–ï¼Œä¸€ä¸ªä¸ªæäº¤ã€‚</p><p>æ¥ä¸‹æ¥æˆ‘ä»¬ä¼šå›åˆ° rocketmq-storeï¼Œæ¥çœ‹çœ‹ RocketMQ çš„é«˜å¯ç”¨ä¹Ÿå°±æ˜¯ HA çš„å®ç°ã€‚</p></div><!--[--><!----><!--]--><footer class="page-meta"><!----><div class="meta-item git-info"><div class="update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: lament.wy@gmail.com">Lament</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link nav-link prev" href="/docs/message-queue/rocketmq/store.html" aria-label="RocketMQ æºç åˆ†æ-æ¶ˆæ¯å­˜å‚¨å’ŒæŒä¹…åŒ–"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->RocketMQ æºç åˆ†æ-æ¶ˆæ¯å­˜å‚¨å’ŒæŒä¹…åŒ–</div></a><a class="route-link nav-link next" href="/docs/message-queue/rocketmq/ha.html" aria-label="RocketMQ æºç åˆ†æ-é«˜å¯ç”¨ HA"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">RocketMQ æºç åˆ†æ-é«˜å¯ç”¨ HA<!----></div></a></nav><!----><!--[--><!----><!--]--><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">Made with â¤ by lament ï¸</div><div class="vp-copyright">Copyright Â© 2024 lament-z </div></footer></div><!--]--><!--]--><!--[--><!----><!----><!--]--><!--]--></div>
    <script type="module" src="/assets/app-BwsoMA_K.js" defer></script>
  </body>
</html>
