import{_ as c}from"./plugin-vue_export-helper-DlAUqK2U.js";import{r as l,o as e,c as t,a as n,b as s,d as o,e as a}from"./app-BwsoMA_K.js";const u={},i=n("h1",{id:"rocketmq-源码分析-消费消息",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#rocketmq-源码分析-消费消息"},[n("span",null,"RocketMQ 源码分析-消费消息")])],-1),k=n("p",null,"RocketMQ 面向的场景很多，不同场景对消息队列的要求是不一样的，尤其是在消费环节。",-1),r=n("p",null,"还是老样子，先介绍一些它的名词/基础概念，然后介绍消费相关的分类，最后跟着源码去看。",-1),d=n("h2",{id:"基础概念",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#基础概念"},[n("span",null,"基础概念")])],-1),m={href:"https://rocketmq.apache.org/zh/docs/4.x/consumer/01concept2",target:"_blank",rel:"noopener noreferrer"},v=a('<h3 id="消费模式" tabindex="-1"><a class="header-anchor" href="#消费模式"><span>消费模式</span></a></h3><div class="hint-container note"><p class="hint-container-title">注</p><p>注意跟后面的 消息模式 MessageModel 进行区分。</p></div><p>推/拉两种模式都支持，本质上差别不大，你把 push 看成自动 pull 即可。</p><ul><li><p>push<br> 在消息队列语境下，push 应该是服务端自动向 Consumer 推送消息。在 RocketMQ 语境下其实就是周期性的自动从 broker 拉取消息并存入 Consumer 本地队列，与此同时 Consumer 不断的从本地队列里取出消息进行处理。</p></li><li><p>pull<br> Consumer 主动从服务端的消息队列中拉取消息。</p></li></ul><p>无论哪种模式都要注意，既要避免消息在本地堆积，同时要注意消费间隔不能太长。</p><p>除了推拉之外，在 Consumer 消费消息这个行为这一层，还支持顺序消费和并发消费。</p><ul><li><p>顺序消费 ConsumeMessageOrderly<br> 顺序消费是在同一个队列上有序，并不是在 Topic 下全局有序，因为 Topic 通常都会有好几个队列。</p><p>你可以通过设置 Topic 下只有一个队列来达成全局有序，牺牲队列本身的高可用，优势是不需要做额外的工作；也可以直接给消息加上全局自增的唯一ID的方式自行实现全局有序，就是实现方案比较麻烦，不过在分布式系统里你总能找到很多现成的功能拿来复用。</p><p>顺序消费仅适用于集群模式。</p></li><li><p>并发消费<br> 就是以并发的方式消费消息。</p></li></ul><h3 id="消费者-consumer" tabindex="-1"><a class="header-anchor" href="#消费者-consumer"><span>消费者 Consumer</span></a></h3><p>可以从消息队列中消费消息的，都统一看作是消费者。 对于 Java 语境，RocketMQ 提供了 <code>MQPushConsumer</code> 和 <code>MQPullConsumer</code> 两个接口以及对应的实现类，以便用户可以快速创建 Consumer，亦或者是自行实现消费客户端。</p><p>PUSH 模式的默认实现类：<code>DefaultMQPushConsumer</code>。</p><p>PULL 模式的默认实现类：<code>DefaultLitePullConsumer</code>，另一个已弃用。</p><h3 id="消费组-consumergroup" tabindex="-1"><a class="header-anchor" href="#消费组-consumergroup"><span>消费组 ConsumerGroup</span></a></h3><p>消费组由订阅相同 Topic 的消费者组成。也就是说 ConsumerGroup 和 Topic 一样必须唯一，而且要和 Topic 一一对应，参考订阅关系。</p><h3 id="messagemode-消息模式" tabindex="-1"><a class="header-anchor" href="#messagemode-消息模式"><span>MessageMode 消息模式</span></a></h3><div class="hint-container tip"><p class="hint-container-title">提示</p><p>消息模式为非官方译名</p></div><p>RocketMQ 提供了两种 MessageMode，集群模式和广播模式。</p><ul><li><p>集群模式 <code>MessageModel.CLUSTERING</code> ：<br> 集群模式下，对 RocketMQ 而言，任意一条消息，只要被消费组内任意 Consumer 消费成功，该消息就被视为已消费。</p></li><li><p>广播模式 <code>MessageModel.BROADCASTING</code>：<br> 广播模式下，对 RocketMQ 而言，任意一条消息，需要被消费组内所有 Consumer 至少消费成功 1 次，该消息才被视为已消费。</p></li></ul><h3 id="集群模式-负载均衡" tabindex="-1"><a class="header-anchor" href="#集群模式-负载均衡"><span>集群模式-负载均衡</span></a></h3><p>集群模式下，消息消费的方式类似于“请求-&gt;网关-&gt;服务”的方式，所以在消息被消费之前可以加一层负载均衡来分配消息。</p><p>目前 RocketMQ 提供了六种分配策略，默认为：AllocateMessageQueueAveragely。</p><h3 id="消费位点-consuming-point" tabindex="-1"><a class="header-anchor" href="#消费位点-consuming-point"><span>消费位点 (consuming point)</span></a></h3><div class="hint-container tip"><p class="hint-container-title">提示</p><p>中英都是官方名称</p></div><p>类似前几篇里我写的消费进度的概念，它代表客户端目前消费到队列中哪个位置。集群模式下 Consumer 会把消费位点提交给 Broker；广播模式下则由 Consumer 自行保存。</p><p>Consumer 启动时有三种初始消费位点的选择：<code>CONSUME_FROM_LAST_OFFSET</code>、<code>CONSUME_FROM_FIRST_OFFSET</code>、<code>CONSUME_FROM_TIMESTAMP</code>。</p><p>初始消费位点的值存储于:<code>DefaultMQPushConsumer.consumeFromWhere</code>。</p><h3 id="订阅关系-订阅关系一致" tabindex="-1"><a class="header-anchor" href="#订阅关系-订阅关系一致"><span>订阅关系 &amp;&amp; 订阅关系一致</span></a></h3><p>消费者组订阅 Topic+Tag，叫订阅关系。</p><p>订阅关系一致：同一个消费者组下所有 Consumer 订阅的 Topic+Tag 必须完全一致。</p><p>如果订阅关系不一致，会导致消费错乱和消息丢失。</p><p>Consumer --n:1-- ConsumerGroup --1:1--&gt; Topic + Tag。</p>',30),b={href:"https://rocketmq.apache.org/zh/docs/4.x/bestPractice/07subscribe",target:"_blank",rel:"noopener noreferrer"},g=a(`<h2 id="源码分析" tabindex="-1"><a class="header-anchor" href="#源码分析"><span>源码分析</span></a></h2><p>主线逻辑是从 <code>DefaultMQPushConsumer</code> 入手，介绍 push/pull 的实现，集群和广播模式下的具体细节等。</p><h3 id="消费端的实现类" tabindex="-1"><a class="header-anchor" href="#消费端的实现类"><span>消费端的实现类</span></a></h3><p>Consumer 跟 Producer 一样也是 Netty 客户端，相似逻辑不再解释。</p><p>从源码可以看到，<code>DefaultMQPullConsumer</code> 和其内部实现类 <code>DefaultMQPullConsumerImpl</code> 已经被标注 Deprecated，PULL 模式目前默认为 <code>DefaultLitePullConsumer</code>。</p><p>我们从 <code>DefaultMQPushConsumer</code> 开始。</p><h3 id="consumer-启动流程" tabindex="-1"><a class="header-anchor" href="#consumer-启动流程"><span>Consumer 启动流程</span></a></h3><p><code>DefaultMQPushConsumer::start</code>，这里面有一步设置消费组，重试组和 DLQ 命名空间的包装也会在这里进行，之后就是 <code>defaultMQPushConsumerImpl.start();</code>，如果开启消息追踪，那么还会启动 <code>traceDispatcher.start();</code>。</p><p>然后来看 <code>defaultMQPushConsumerImpl.start();</code>：</p><ul><li>defaultMQPushConsumerImpl.start</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">MQClientException</span> <span class="token punctuation">{</span>
<span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>serviceState<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token constant">CREATE_JUST</span><span class="token operator">:</span>
        <span class="token comment">// ... 省略日志</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> <span class="token class-name">ServiceState</span><span class="token punctuation">.</span><span class="token constant">START_FAILED</span><span class="token punctuation">;</span>
        <span class="token comment">// 校验 Consumer 客户端配置，不清楚客户端配置的可以去看一眼</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">checkConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 这里做两件事</span>
        <span class="token comment">// 1. 把 defaultMQPushConsumer 中的订阅复制一份给 rebalanceImpl</span>
        <span class="token comment">// 2. 如果是 MessageModel 是集群模式，那么创建 retryTopic，并再一复制订阅关系，一起添加到 rebalanceImpl</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">copySubscription</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// InstanceName 校验，其实这一步可以放进 checkConfig()方法里</span>
        <span class="token comment">// 如果你的 InatanceName 是默认值，将修改为 PID+纳秒级时间戳</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">MessageModel</span><span class="token punctuation">.</span><span class="token constant">CLUSTERING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">changeInstanceNameToPID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 跟 Producer 一样，创建 netty 客户端</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory <span class="token operator">=</span> <span class="token class-name">MQClientManager</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getOrCreateMQClientInstance</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rpcHook<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 装配 rebalanceImpl ，关于 RebalanceImpl 后面再说，你知道他是个消费行为之前的负载均衡器即可</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setConsumerGroup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setAllocateMessageQueueStrategy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getAllocateMessageQueueStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setmQClientFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 拉取消息 API 的包装器</span>
        <span class="token comment">// 无论pull or push 模式，都是 consumer 从 broker 上把消息拉回本地再进行处理</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pullAPIWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PullAPIWrapper</span><span class="token punctuation">(</span>
            mQClientFactory<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">isUnitMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>pullAPIWrapper<span class="token punctuation">.</span><span class="token function">registerFilterMessageHook</span><span class="token punctuation">(</span>filterMessageHookList<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 这里又来到一个 Deprecated 方法</span>
        <span class="token comment">// 这部分就是前文提到的消费位点的存储</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getOffsetStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getOffsetStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>

            <span class="token comment">// 根据消费模式判定</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">case</span> <span class="token constant">BROADCASTING</span><span class="token operator">:</span> <span class="token comment">// 广播模式本地存取，这里只初始化 offsetStore</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LocalFileOffsetStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">case</span> <span class="token constant">CLUSTERING</span><span class="token operator">:</span> <span class="token comment">// 集群模式，消费位点要上传 broker，所以这里要从 broker 上拉</span>
                    <span class="token comment">// 这里初始化 offsetStore</span>
                    <span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RemoteBrokerOffsetStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token operator">:</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 给外部包装类初始化 offsetStore</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">setOffsetStore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// offsetStore 的具体类型取决于上面的代码， LocalFileOffsetStore or RemoteBrokerOffsetStore</span>
        <span class="token comment">// LocalFileOffsetStore.load 就是从本地文件中取出消费位点</span>
        <span class="token comment">// 路径是 user.home/.rocketmq_offsets/clientID/groupName/offsets.json</span>
        <span class="token comment">// 流程就是 读文件，然后 json 序列化为 wrapper 对象，然后把对象的值传给 offsetTable，顺带打印 load 日志</span>

        <span class="token comment">// 集群模式从 Broker 远程拉取，所以 RemoteBrokerOffsetStore::load 啥也不干。</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageListenerInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">MessageListenerOrderly</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 顺序消费 -&gt; ConsumeMessageOrderlyService</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumeOrderly <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumeMessageService <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">ConsumeMessageOrderlyService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">MessageListenerOrderly</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageListenerInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageListenerInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">instanceof</span> <span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 并发消费 -&gt; ConsumeMessageConcurrentlyService</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumeOrderly <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>consumeMessageService <span class="token operator">=</span>
                <span class="token keyword">new</span> <span class="token class-name">ConsumeMessageConcurrentlyService</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token class-name">MessageListenerConcurrently</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getMessageListenerInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// ConsumeMessageOrderlyService 仅适用于集群模式</span>
        <span class="token comment">// 它会提交一个周期任务给 scheduledExecutorService（单线程），scheduledExecutorService 每 20 秒调用 rebalanceImpl().lockAll() 对远程队列上锁。</span>

        <span class="token comment">// ConsumeMessageConcurrentlyService</span>
        <span class="token comment">// 提交一个周期任务给 cleanExpireMsgExecutors（单线程），每 15 分钟清理一次过期消息，避免消费卡住。</span>
        <span class="token comment">// 后面单独来看这俩 Service</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumeMessageService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 就是把消费组和对应的 Consumer 存入 consumerTable</span>
        <span class="token keyword">boolean</span> registerOK <span class="token operator">=</span> mQClientFactory<span class="token punctuation">.</span><span class="token function">registerConsumer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registerOK<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 注册失败直接关闭</span>
          <span class="token comment">// ...</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 主要看这个方法</span>
        mQClientFactory<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;the consumer [{}] start OK.&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> <span class="token class-name">ServiceState</span><span class="token punctuation">.</span><span class="token constant">RUNNING</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token constant">RUNNING</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token constant">START_FAILED</span><span class="token operator">:</span>
      <span class="token keyword">case</span> <span class="token constant">SHUTDOWN_ALREADY</span><span class="token operator">:</span>
          <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">MQClientException</span><span class="token punctuation">(</span><span class="token string">&quot;The PushConsumer service state not OK, maybe started once, &quot;</span>
              <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState
              <span class="token operator">+</span> <span class="token class-name">FAQUrl</span><span class="token punctuation">.</span><span class="token function">suggestTodo</span><span class="token punctuation">(</span><span class="token class-name">FAQUrl</span><span class="token punctuation">.</span><span class="token constant">CLIENT_SERVICE_NOT_OK</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
              <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 从 NameSrv 更新路由信息，并存入 topicRouteTable</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateTopicSubscribeInfoWhenSubscriptionChanged</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 发送远程请求 RequestCode.CHECK_CLIENT_CONFIG</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">checkClientInBroker</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">sendHeartbeatToAllBrokerWithLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 启动 rebalanceService</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">rebalanceImmediately</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>mQClientFactory.start();</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code>      <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> <span class="token class-name">ServiceState</span><span class="token punctuation">.</span><span class="token constant">START_FAILED</span><span class="token punctuation">;</span>
      <span class="token comment">// If not specified,looking address from name server</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientConfig<span class="token punctuation">.</span><span class="token function">getNamesrvAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientAPIImpl<span class="token punctuation">.</span><span class="token function">fetchNameServerAddr</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// Start request-response channel</span>
      <span class="token comment">// netty client</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientAPIImpl<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Start various schedule tasks</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startScheduledTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Start pull service</span>
      <span class="token comment">// 重点看 pullMessageService</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pullMessageService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Start rebalance service</span>
      <span class="token comment">// rebalanceService 主要是定期执行 doRebalance</span>
      <span class="token comment">// doRebalance 有三种实现方法，对应不同 Consumer 实现类</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceService<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// Start push service</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQProducer<span class="token punctuation">.</span><span class="token function">getDefaultMQProducerImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;the client factory [{}] start OK&quot;</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>clientId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>serviceState <span class="token operator">=</span> <span class="token class-name">ServiceState</span><span class="token punctuation">.</span><span class="token constant">RUNNING</span><span class="token punctuation">;</span>          
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>总结</li></ul><p>到这里启动就完成了，简单总结一下启动流程：<br> 第一步，初始化和组装 <code>rebalanceImpl</code> 和 Consumer ；<br> 第二步，载入消费位点，广播模式存在本地，集群模式存储在 broker；<br> 第三步，初始化并启动 <code>consumeMessageService</code>，实现类有两个，顺序消费是 <code>ConsumeMessageOrderlyService</code>，并行消费是 <code>ConsumeMessageConcurrentlyService</code>；<br> 第四步，把 Consumer 注册到 consumerTable； 最后启动 Consumer 和各种 Services。</p><p>然后我们来看“消费”。</p><h3 id="consumemessageservice" tabindex="-1"><a class="header-anchor" href="#consumemessageservice"><span>ConsumeMessageService</span></a></h3><p>消费这部分主要关注 <code>ConsumeMessageService</code> 和 <code>PullMessageService</code>这两块。</p><p><code>ConsumeMessageService</code> 前面已经看到了，它有顺序消费和并发消费两个实现类，这个 Service 主要职责就是负责消费消息。</p><ul><li><p>ConsumeMessageOrderlyService 顺序消费</p><p>无论是哪个实现类，<code>ConsumeMessageService</code> 一定会有 <code>consumeExecutor</code> 属性，它是执行消费行为的线程/线程池，这里就统称执行器。<code>private final ThreadPoolExecutor consumeExecutor;</code>。</p><p><code>ConsumeMessageOrderlyService</code> 的 <code>consumeExecutor</code> 是一个包含 20 个线程的线程池，并发版本的也一样。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>consumeExecutor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumeThreadMin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// core 20</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumeThreadMax</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// max 20</span>
        <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">,</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumeRequestQueue<span class="token punctuation">,</span> <span class="token comment">// workQueue LinkedBlockingQueue</span>
        <span class="token keyword">new</span> <span class="token class-name">ThreadFactoryImpl</span><span class="token punctuation">(</span><span class="token string">&quot;ConsumeMessageThread_&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>线程池有了，我们来看线程池要执行的任务： <code>ConsumeRequest</code>。</p><p>代码太长还是大量省略，除了要看 run 方法外，要注意创建 <code>ConsumeRequest</code> 时，需要接收两个队列作为参数， <code>processQueue</code> 和 <code>messageQueue</code>。</p><p>processQueue 暂且就简单理解为待消费的消息队列(local)，messageQueue 就是待拉取的消息队列(remote)。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// ConsumeRequest::run   </span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 首先检查 processQueue.isDropped ...</span>

  <span class="token comment">// 上锁，保证一个队列一次只被一个线程消费</span>
    <span class="token keyword">final</span> <span class="token class-name">Object</span> objLock <span class="token operator">=</span> messageQueueLock<span class="token punctuation">.</span><span class="token function">fetchLockObject</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>objLock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 分支判断</span>
    <span class="token comment">// 如果是广播模式 或者 processQueue 被锁住且锁未过期 则开始进行循环</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">boolean</span> continueConsume <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> continueConsume<span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 当成 while(continueConsume) 即可</span>
        <span class="token comment">// 再次 检查 processQueue.isDropped ，是则 break</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span> log <span class="token operator">&amp;</span> <span class="token keyword">break</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
        <span class="token comment">// 如果是集群模式 且 processQueue 未被锁住，则尝试重新上锁并重新消费</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token comment">// 这个方法就是 先对第一个参数 messageQueue 上锁，</span>
          <span class="token comment">// 如果成功，则 10ms 后重新提交一个 ConsumeRequest 请求，</span>
          <span class="token comment">// 如果不成功，则 3s 后重新提交一个 ConsumeRequest 请求。</span>
          <span class="token class-name">ConsumeMessageOrderlyService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">tryLockLaterAndReconsume</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>messageQueue<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 如果 集群模式 且 processQueue 锁过期，也是 tryLockLaterAndReconsume + break; 跟前面一样。</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
        <span class="token comment">// 计算真实提交间隔 interval  当前时间 - beginTime，注意 beginTime 在循环外</span>
        <span class="token keyword">long</span> interval <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> beginTime<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>interval <span class="token operator">&gt;</span> <span class="token constant">MAX_TIME_CONSUME_CONTINUOUSLY</span> <span class="token comment">/*60s*/</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// MAX_TIME_CONSUME_CONTINUOUSLY 是 rocketmq.client.maxTimeConsumeContinuously 的值。</span>
            <span class="token class-name">ConsumeMessageOrderlyService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">submitConsumeRequestLater</span><span class="token punctuation">(</span>processQueue<span class="token punctuation">,</span> messageQueue<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 以上的四个 if + break 都是为了保证当前消息一定要被消费</span>

        <span class="token comment">// 然后是消息的批量处理 consumeMessageBatchMaxSize 默认为 1</span>
        <span class="token comment">// 从 processQueue.takeMessages 方法中就可以看出来，</span>
        <span class="token comment">// 平时消息是存储于 msgTreeMap 中，只有顺序消费时才取出对应数量消息写入 consumingMsgOrderlyTreeMap</span>
         <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>processQueue<span class="token punctuation">.</span><span class="token function">takeMessages</span><span class="token punctuation">(</span>consumeBatchSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建并装配 ConsumeOrderlyContext 略</span>

        <span class="token comment">// 这里就是你自己实现的 Consumer.registerMessageListener 里面</span>
        <span class="token comment">// 注册并实现的 listener 的 consumeMessage 方法的调用。</span>
        <span class="token comment">// 换句话说这一步就是执行真正的消费</span>
        status <span class="token operator">=</span> messageListener<span class="token punctuation">.</span><span class="token function">consumeMessage</span><span class="token punctuation">(</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableList</span><span class="token punctuation">(</span>msgs<span class="token punctuation">)</span><span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 后面全部略 有兴趣可以自己看，就是一些后续处理 ...</span>
        <span class="token comment">// 退出循环的条件就是 continueConsume == false；</span>

        <span class="token comment">// 消费的最后一步， ack 消息</span>
         continueConsume <span class="token operator">=</span> <span class="token class-name">ConsumeMessageOrderlyService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">processConsumeResult</span><span class="token punctuation">(</span>msgs<span class="token punctuation">,</span> status<span class="token punctuation">,</span> context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>由此我们可以知道顺序消费时，ProcessQueue 会从 msgTreeMap 中取出 batchSize（默认为 1）条消息存入 consumingMsgOrderlyTreeMap 并进行批量消费。</p><p>目前执行器 <code>consumeExecutor</code> 和线程任务 <code>ConsumeRequest</code> 都有了，那么 <code>ConsumeRequest</code> 是如何提交给 <code>consumeExecutor</code> 的工作队列的呢？</p><p>就是 <code>ConsumeMessageOrderlyService::submitConsumeRequest</code> 方法，非常简单，根据参数提供的俩 Queue 来创建一个 <code>ConsumeRequest</code>，然后直接提交。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">submitConsumeRequest</span><span class="token punctuation">(</span>
    <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> msgs<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">ProcessQueue</span> processQueue<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token class-name">MessageQueue</span> messageQueue<span class="token punctuation">,</span>
    <span class="token keyword">final</span> <span class="token keyword">boolean</span> dispathToConsume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dispathToConsume<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ConsumeRequest</span> consumeRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsumeRequest</span><span class="token punctuation">(</span>processQueue<span class="token punctuation">,</span> messageQueue<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>consumeExecutor<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span>consumeRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>至此，围绕 <code>consumeExecutor</code> 的基本要素已经凑齐。</p><p>接下来我们要来看消息是怎么从 broker 传递过来的，然后经过了哪些处理，最后如何被提交给 <code>consumeExecutor</code> 的。 换句话说就是：<code>ConsumeMessageOrderlyService::submitConsumeRequest</code> 这个方法是如何被调用的。</p><p>为了方便理解，我们就不从 <code>submitConsumeRequest</code> 向上追踪了，读者可以自行从反推验证。</p></li></ul><h3 id="pullmessageservice" tabindex="-1"><a class="header-anchor" href="#pullmessageservice"><span>PullMessageService</span></a></h3><p>还记得前面启动流程中注释了重点的 <code>this.pullMessageService.start();</code> 么。</p><p><code>PullMessageService</code> 是就是负责把消息从 Broker 拉取到 Consumer 本地，并将消息封装成 <code>ConsumeRequest</code> 提交给线程池的重要 Service 。</p><p><code>PullMessageService</code> 内维护一个单线程执行器 <code>scheduledExecutorService</code>，负责定期把 <code>PullRequest</code> 提交到 <code>pullRequestQueue</code> 中。</p><p>同时 <code>PullMessageService</code> 自身也是一个服务线程 (ServiceThread, RocketMQ 内部自定义的抽象类)，<code>PullMessageService</code> 的工作就是不停的从 <code>pullRequestQueue</code> 中取出 <code>PullRequest</code> 并执行 <code>PullMessageService.pullMessage(final PullRequest pullRequest)</code> 方法处理请求。</p><p><code>PullMessageService::pullMessage</code> 实际上也并不会真正对请求进行处理，它只是选择一个 Consumer，通过调用 <code>Consumer.pullMessage(final PullRequest pullRequest)</code> 来处理。 可能是因为 <code>DefaultMQPullConsumerImpl</code> 被弃用的原因，这里它默认所有的 Consumer 都是 <code>DefaultMQPushConsumerImpl</code> 类型，（强制类型转换）。 因此也可以认为是 <code>DefaultMQPushConsumerImpl::pullMessage</code> 才是真正处理 <code>PullRequest</code> 请求的方法。 <code>DefaultMQPushConsumerImpl::pullMessage</code> 的主要工作就是从 broker 上拉消息回来，它里面的 callback 则是对拉回来的消息进行处理，比如解码啊、存入 msgTreeMap 啊、把消息提交给 consumeExecutor 去执行什么的。</p>`,26),C=a(`<li><p>PullMessageService 的属性和基础方法</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PullMessageService</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceThread</span> <span class="token punctuation">{</span>
  <span class="token comment">// 存放 pullRequest 请求的队列</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PullRequest</span><span class="token punctuation">&gt;</span></span> pullRequestQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PullRequest</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">MQClientInstance</span> mQClientFactory<span class="token punctuation">;</span>
  <span class="token comment">// 单线程、周期执行</span>
  <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ScheduledExecutorService</span> scheduledExecutorService <span class="token operator">=</span> <span class="token class-name">Executors</span>
      <span class="token punctuation">.</span><span class="token function">newSingleThreadScheduledExecutor</span><span class="token punctuation">(</span>r <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">&quot;PullMessageServiceScheduledThread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 构造方法</span>
  <span class="token keyword">public</span> <span class="token class-name">PullMessageService</span><span class="token punctuation">(</span><span class="token class-name">MQClientInstance</span> mQClientFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory <span class="token operator">=</span> mQClientFactory<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// PullMessageService 的 run 方法</span>
  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; service started&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token comment">// 从 pullRequestQueue 中取出 pullRequest</span>
              <span class="token class-name">PullRequest</span> pullRequest <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pullRequestQueue<span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">// 转交给 consumer.pullMessage 去执行</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">pullMessage</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> ignored<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Pull Message Service Run Method exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

      log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServiceName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; service end&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>pullRequest 存入 pullRequestQueue</p><p>两个方法，<code>executePullRequestImmediately</code> 和 <code>executePullRequestLater</code>。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">PullRequest</span> pullRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>pullRequestQueue<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;executePullRequestImmediately pullRequestQueue.put&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">executePullRequestLater</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">PullRequest</span> pullRequest<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">long</span> timeDelay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 就是定时调用 executePullRequestImmediately</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>scheduledExecutorService<span class="token punctuation">.</span><span class="token function">schedule</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">PullMessageService</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">,</span> timeDelay<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;PullMessageServiceScheduledThread has shutdown&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>PullMessageService::pullMessage</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">pullMessage</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">PullRequest</span> pullRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 从 MQClientInstance.consumerTable 中 以 consumerGroup 为 KEY 取出 consumer</span>
      <span class="token comment">// 这个 consumer 就是之前 DefaultMQPushConsumerImpl::start 中注册那一步存入 consumerTable 的</span>
      <span class="token keyword">final</span> <span class="token class-name">MQConsumerInner</span> consumer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">selectConsumer</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>consumer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 强转</span>
          <span class="token class-name">DefaultMQPushConsumerImpl</span> impl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">)</span> consumer<span class="token punctuation">;</span>
          <span class="token comment">// 实际处理</span>
          impl<span class="token punctuation">.</span><span class="token function">pullMessage</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;No matched consumer for the PullRequest {}, drop it&quot;</span><span class="token punctuation">,</span> pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>`,3),f=a(`<p>PullRequest</p><p>看如何处理 <code>PullRequest</code> 请求前，先看一下它是什么。</p><p>简单的说就是拉取消息的请求。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// PullRequest 属性、重要重写 Override 方法</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PullRequest</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> consumerGroup<span class="token punctuation">;</span>
    <span class="token comment">// 这俩 Queue 跟 ConsumeRequest 中语义一致</span>
    <span class="token comment">// 代表远程 Queue</span>
    <span class="token comment">// 它里面只存储 topic + brokerName + queueID</span>
    <span class="token comment">// 这三个属性足够 Consumer 确定自己从哪个 Broker 找到哪个 topic 下的哪个队列</span>
    <span class="token keyword">private</span> <span class="token class-name">MessageQueue</span> messageQueue<span class="token punctuation">;</span>
    <span class="token comment">// 消息存入的本地 Queue</span>
    <span class="token comment">// ProcessQueue 可以自己去看一下</span>
    <span class="token keyword">private</span> <span class="token class-name">ProcessQueue</span> processQueue<span class="token punctuation">;</span>
    <span class="token comment">// 远程 Queue 的 offset，消费进度，消费位点</span>
    <span class="token keyword">private</span> <span class="token keyword">long</span> nextOffset<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> previouslyLocked <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>


    <span class="token comment">// hashcode:  (1*31 + consumerGroup.hashcode) * 31 + messageQueue.hashcode</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token keyword">int</span> prime <span class="token operator">=</span> <span class="token number">31</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> prime <span class="token operator">*</span> result <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>consumerGroup <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> consumerGroup<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        result <span class="token operator">=</span> prime <span class="token operator">*</span> result <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>messageQueue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> messageQueue<span class="token punctuation">.</span><span class="token function">hashCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> result<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Object</span> obj<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token operator">==</span> obj<span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> obj<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token class-name">PullRequest</span> other <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">PullRequest</span><span class="token punctuation">)</span> obj<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>consumerGroup <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>other<span class="token punctuation">.</span>consumerGroup <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
              <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>consumerGroup<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>consumerGroup<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>messageQueue <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>other<span class="token punctuation">.</span>messageQueue <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
              <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>messageQueue<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>other<span class="token punctuation">.</span>messageQueue<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>它的 hashCode 计算方式类似 String.hashCode，基本上也是基于以下公式：</p>`,5),h={class:"MathJax",jax:"SVG",overflow:"overflow",display:"true",style:{position:"relative"}},y={style:{"vertical-align":"-0.561ex"},xmlns:"http://www.w3.org/2000/svg",width:"27.863ex",height:"2.253ex",role:"img",focusable:"false",viewBox:"0 -748 12315.6 996","aria-hidden":"true"},w=a('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtext"><path data-c="A0" d=""></path></g><g data-mml-node="mi" transform="translate(332,0)"><path data-c="1D453" d="M552 636C552 682 506 705 465 705C431 705 368 687 338 588C332 567 329 557 305 431L236 431C217 431 206 431 206 412C206 400 215 400 234 400L300 400L225 5C207-92 190-183 138-183C134-183 109-183 90-165C136-162 145-126 145-111C145-88 127-76 108-76C82-76 53-98 53-136C53-181 97-205 138-205C193-205 233-146 251-108C283-45 306 76 307 83L367 400L453 400C473 400 483 400 483 420C483 431 473 431 456 431L373 431C384 489 383 487 394 545C398 566 412 637 418 649C427 668 444 683 465 683C469 683 495 683 514 665C470 661 460 626 460 611C460 588 478 576 497 576C523 576 552 598 552 636Z"></path></g><g data-mml-node="mo" transform="translate(884,0)"><path data-c="28" d="M332-238C332-235 330-232 328-230C224-152 155 48 155 208L155 292C155 452 224 652 328 730C330 732 332 735 332 738C332 743 327 748 322 748C320 748 318 747 316 746C206 663 101 463 101 292L101 208C101 37 206-163 316-246C318-247 320-248 322-248C327-248 332-243 332-238Z"></path></g><g data-mml-node="msub" transform="translate(1273,0)"><g data-mml-node="mi"><path data-c="1D465" d="M527 376C527 428 468 442 434 442C376 442 341 389 329 366C304 432 250 442 221 442C117 442 60 313 60 288C60 278 72 278 72 278C80 278 83 280 85 289C119 395 185 420 219 420C238 420 273 411 273 353C273 322 256 255 219 115C203 53 168 11 124 11C118 11 95 11 74 24C99 29 121 50 121 78C121 105 99 113 84 113C54 113 29 87 29 55C29 9 79-11 123-11C189-11 225 59 228 65C240 28 276-11 336-11C439-11 496 118 496 143C496 153 487 153 484 153C475 153 473 149 471 142C438 35 370 11 338 11C299 11 283 43 283 77C283 99 289 121 300 165L334 302C340 328 363 420 433 420C438 420 462 420 483 407C455 402 435 377 435 353C435 337 446 318 473 318C495 318 527 336 527 376Z"></path></g><g data-mml-node="TeXAtom" transform="translate(605,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D45B" d="M571 143C571 153 562 153 559 153C549 153 549 150 544 135C524 67 491 11 442 11C425 11 418 21 418 44C418 69 427 93 436 115C455 168 497 278 497 335C497 402 454 442 382 442C292 442 243 378 226 355C221 411 180 442 134 442C88 442 69 403 59 385C43 351 29 292 29 288C29 278 41 278 41 278C51 278 52 279 58 301C75 372 95 420 131 420C151 420 162 407 162 374C162 353 159 342 146 290L88 59C85 44 79 21 79 16C79-2 93-11 108-11C120-11 138-3 145 17C146 19 158 66 164 91L186 181C192 203 198 225 203 248L216 298C231 329 284 420 379 420C424 420 433 383 433 350C433 288 384 160 368 117C359 94 358 82 358 71C358 24 393-11 440-11C534-11 571 135 571 143Z"></path></g><g data-mml-node="mo" transform="translate(600,0)"><path data-c="2B" d="M722 250C722 261 713 270 702 270L409 270L409 563C409 574 400 583 389 583C378 583 369 574 369 563L369 270L76 270C65 270 56 261 56 250C56 239 65 230 76 230L369 230L369-63C369-74 378-83 389-83C400-83 409-74 409-63L409 230L702 230C713 230 722 239 722 250Z"></path></g><g data-mml-node="mn" transform="translate(1378,0)"><path data-c="31" d="M419 0L419 31L387 31C297 31 294 42 294 79L294 640C294 664 294 666 271 666C209 602 121 602 89 602L89 571C109 571 168 571 220 597L220 79C220 43 217 31 127 31L95 31L95 0C130 3 217 3 257 3C297 3 384 3 419 0Z"></path></g></g></g><g data-mml-node="mo" transform="translate(3255.9,0)"><path data-c="29" d="M288 208L288 292C288 463 183 663 73 746C71 747 69 748 67 748C62 748 57 743 57 738C57 735 59 732 61 730C165 652 234 452 234 292L234 208C234 48 165-152 61-230C59-232 57-235 57-238C57-243 62-248 67-248C69-248 71-247 73-246C183-163 288 37 288 208Z"></path></g><g data-mml-node="mo" transform="translate(3922.7,0)"><path data-c="3D" d="M722 347C722 358 713 367 702 367L76 367C65 367 56 358 56 347C56 336 65 327 76 327L702 327C713 327 722 336 722 347ZM722 153C722 164 713 173 702 173L76 173C65 173 56 164 56 153C56 142 65 133 76 133L702 133C713 133 722 142 722 153Z"></path></g><g data-mml-node="mn" transform="translate(4978.5,0)"><path data-c="33" d="M457 171C457 253 394 331 290 352C372 379 430 449 430 528C430 610 342 666 246 666C145 666 69 606 69 530C69 497 91 478 120 478C151 478 171 500 171 529C171 579 124 579 109 579C140 628 206 641 242 641C283 641 338 619 338 529C338 517 336 459 310 415C280 367 246 364 221 363C213 362 189 360 182 360C174 359 167 358 167 348C167 337 174 337 191 337L235 337C317 337 354 269 354 171C354 35 285 6 241 6C198 6 123 23 88 82C123 77 154 99 154 137C154 173 127 193 98 193C74 193 42 179 42 135C42 44 135-22 244-22C366-22 457 69 457 171Z"></path><path data-c="31" d="M419 0L419 31L387 31C297 31 294 42 294 79L294 640C294 664 294 666 271 666C209 602 121 602 89 602L89 571C109 571 168 571 220 597L220 79C220 43 217 31 127 31L95 31L95 0C130 3 217 3 257 3C297 3 384 3 419 0Z" transform="translate(500,0)"></path></g><g data-mml-node="mo" transform="translate(6200.7,0)"><path data-c="22C5" d="M192 250C192 279 168 303 139 303C110 303 86 279 86 250C86 221 110 197 139 197C168 197 192 221 192 250Z"></path></g><g data-mml-node="mi" transform="translate(6700.9,0)"><path data-c="1D453" d="M552 636C552 682 506 705 465 705C431 705 368 687 338 588C332 567 329 557 305 431L236 431C217 431 206 431 206 412C206 400 215 400 234 400L300 400L225 5C207-92 190-183 138-183C134-183 109-183 90-165C136-162 145-126 145-111C145-88 127-76 108-76C82-76 53-98 53-136C53-181 97-205 138-205C193-205 233-146 251-108C283-45 306 76 307 83L367 400L453 400C473 400 483 400 483 420C483 431 473 431 456 431L373 431C384 489 383 487 394 545C398 566 412 637 418 649C427 668 444 683 465 683C469 683 495 683 514 665C470 661 460 626 460 611C460 588 478 576 497 576C523 576 552 598 552 636Z"></path></g><g data-mml-node="mo" transform="translate(7252.9,0)"><path data-c="28" d="M332-238C332-235 330-232 328-230C224-152 155 48 155 208L155 292C155 452 224 652 328 730C330 732 332 735 332 738C332 743 327 748 322 748C320 748 318 747 316 746C206 663 101 463 101 292L101 208C101 37 206-163 316-246C318-247 320-248 322-248C327-248 332-243 332-238Z"></path></g><g data-mml-node="msub" transform="translate(7641.9,0)"><g data-mml-node="mi"><path data-c="1D465" d="M527 376C527 428 468 442 434 442C376 442 341 389 329 366C304 432 250 442 221 442C117 442 60 313 60 288C60 278 72 278 72 278C80 278 83 280 85 289C119 395 185 420 219 420C238 420 273 411 273 353C273 322 256 255 219 115C203 53 168 11 124 11C118 11 95 11 74 24C99 29 121 50 121 78C121 105 99 113 84 113C54 113 29 87 29 55C29 9 79-11 123-11C189-11 225 59 228 65C240 28 276-11 336-11C439-11 496 118 496 143C496 153 487 153 484 153C475 153 473 149 471 142C438 35 370 11 338 11C299 11 283 43 283 77C283 99 289 121 300 165L334 302C340 328 363 420 433 420C438 420 462 420 483 407C455 402 435 377 435 353C435 337 446 318 473 318C495 318 527 336 527 376Z"></path></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D45B" d="M571 143C571 153 562 153 559 153C549 153 549 150 544 135C524 67 491 11 442 11C425 11 418 21 418 44C418 69 427 93 436 115C455 168 497 278 497 335C497 402 454 442 382 442C292 442 243 378 226 355C221 411 180 442 134 442C88 442 69 403 59 385C43 351 29 292 29 288C29 278 41 278 41 278C51 278 52 279 58 301C75 372 95 420 131 420C151 420 162 407 162 374C162 353 159 342 146 290L88 59C85 44 79 21 79 16C79-2 93-11 108-11C120-11 138-3 145 17C146 19 158 66 164 91L186 181C192 203 198 225 203 248L216 298C231 329 284 420 379 420C424 420 433 383 433 350C433 288 384 160 368 117C359 94 358 82 358 71C358 24 393-11 440-11C534-11 571 135 571 143Z"></path></g></g><g data-mml-node="mo" transform="translate(8721.2,0)"><path data-c="29" d="M288 208L288 292C288 463 183 663 73 746C71 747 69 748 67 748C62 748 57 743 57 738C57 735 59 732 61 730C165 652 234 452 234 292L234 208C234 48 165-152 61-230C59-232 57-235 57-238C57-243 62-248 67-248C69-248 71-247 73-246C183-163 288 37 288 208Z"></path></g><g data-mml-node="mo" transform="translate(9332.4,0)"><path data-c="2B" d="M722 250C722 261 713 270 702 270L409 270L409 563C409 574 400 583 389 583C378 583 369 574 369 563L369 270L76 270C65 270 56 261 56 250C56 239 65 230 76 230L369 230L369-63C369-74 378-83 389-83C400-83 409-74 409-63L409 230L702 230C713 230 722 239 722 250Z"></path></g><g data-mml-node="msub" transform="translate(10332.7,0)"><g data-mml-node="mi"><path data-c="1D465" d="M527 376C527 428 468 442 434 442C376 442 341 389 329 366C304 432 250 442 221 442C117 442 60 313 60 288C60 278 72 278 72 278C80 278 83 280 85 289C119 395 185 420 219 420C238 420 273 411 273 353C273 322 256 255 219 115C203 53 168 11 124 11C118 11 95 11 74 24C99 29 121 50 121 78C121 105 99 113 84 113C54 113 29 87 29 55C29 9 79-11 123-11C189-11 225 59 228 65C240 28 276-11 336-11C439-11 496 118 496 143C496 153 487 153 484 153C475 153 473 149 471 142C438 35 370 11 338 11C299 11 283 43 283 77C283 99 289 121 300 165L334 302C340 328 363 420 433 420C438 420 462 420 483 407C455 402 435 377 435 353C435 337 446 318 473 318C495 318 527 336 527 376Z"></path></g><g data-mml-node="TeXAtom" transform="translate(605,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D45B" d="M571 143C571 153 562 153 559 153C549 153 549 150 544 135C524 67 491 11 442 11C425 11 418 21 418 44C418 69 427 93 436 115C455 168 497 278 497 335C497 402 454 442 382 442C292 442 243 378 226 355C221 411 180 442 134 442C88 442 69 403 59 385C43 351 29 292 29 288C29 278 41 278 41 278C51 278 52 279 58 301C75 372 95 420 131 420C151 420 162 407 162 374C162 353 159 342 146 290L88 59C85 44 79 21 79 16C79-2 93-11 108-11C120-11 138-3 145 17C146 19 158 66 164 91L186 181C192 203 198 225 203 248L216 298C231 329 284 420 379 420C424 420 433 383 433 350C433 288 384 160 368 117C359 94 358 82 358 71C358 24 393-11 440-11C534-11 571 135 571 143Z"></path></g><g data-mml-node="mo" transform="translate(600,0)"><path data-c="2B" d="M722 250C722 261 713 270 702 270L409 270L409 563C409 574 400 583 389 583C378 583 369 574 369 563L369 270L76 270C65 270 56 261 56 250C56 239 65 230 76 230L369 230L369-63C369-74 378-83 389-83C400-83 409-74 409-63L409 230L702 230C713 230 722 239 722 250Z"></path></g><g data-mml-node="mn" transform="translate(1378,0)"><path data-c="31" d="M419 0L419 31L387 31C297 31 294 42 294 79L294 640C294 664 294 666 271 666C209 602 121 602 89 602L89 571C109 571 168 571 220 597L220 79C220 43 217 31 127 31L95 31L95 0C130 3 217 3 257 3C297 3 384 3 419 0Z"></path></g></g></g></g></g>',1),M=[w],R=n("mjx-assistive-mml",{unselectable:"on",display:"block"},[n("math",{xmlns:"http://www.w3.org/1998/Math/MathML",display:"block"},[n("mtext",null," "),n("mi",null,"f"),n("mo",{stretchy:"false"},"("),n("msub",null,[n("mi",null,"x"),n("mrow",{"data-mjx-texclass":"ORD"},[n("mi",null,"n"),n("mo",null,"+"),n("mn",null,"1")])]),n("mo",{stretchy:"false"},")"),n("mo",null,"="),n("mn",null,"31"),n("mo",null,"⋅"),n("mi",null,"f"),n("mo",{stretchy:"false"},"("),n("msub",null,[n("mi",null,"x"),n("mi",null,"n")]),n("mo",{stretchy:"false"},")"),n("mo",null,"+"),n("msub",null,[n("mi",null,"x"),n("mrow",{"data-mjx-texclass":"ORD"},[n("mi",null,"n"),n("mo",null,"+"),n("mn",null,"1")])])])],-1),S={class:"MathJax",jax:"SVG",overflow:"overflow",style:{position:"relative"}},Q={style:{"vertical-align":"-0.357ex"},xmlns:"http://www.w3.org/2000/svg",width:"2.442ex",height:"1.357ex",role:"img",focusable:"false",viewBox:"0 -442 1079.3 599.8","aria-hidden":"true"},q=a('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D465" d="M527 376C527 428 468 442 434 442C376 442 341 389 329 366C304 432 250 442 221 442C117 442 60 313 60 288C60 278 72 278 72 278C80 278 83 280 85 289C119 395 185 420 219 420C238 420 273 411 273 353C273 322 256 255 219 115C203 53 168 11 124 11C118 11 95 11 74 24C99 29 121 50 121 78C121 105 99 113 84 113C54 113 29 87 29 55C29 9 79-11 123-11C189-11 225 59 228 65C240 28 276-11 336-11C439-11 496 118 496 143C496 153 487 153 484 153C475 153 473 149 471 142C438 35 370 11 338 11C299 11 283 43 283 77C283 99 289 121 300 165L334 302C340 328 363 420 433 420C438 420 462 420 483 407C455 402 435 377 435 353C435 337 446 318 473 318C495 318 527 336 527 376Z"></path></g><g data-mml-node="mi" transform="translate(605,-150) scale(0.707)"><path data-c="1D45B" d="M571 143C571 153 562 153 559 153C549 153 549 150 544 135C524 67 491 11 442 11C425 11 418 21 418 44C418 69 427 93 436 115C455 168 497 278 497 335C497 402 454 442 382 442C292 442 243 378 226 355C221 411 180 442 134 442C88 442 69 403 59 385C43 351 29 292 29 288C29 278 41 278 41 278C51 278 52 279 58 301C75 372 95 420 131 420C151 420 162 407 162 374C162 353 159 342 146 290L88 59C85 44 79 21 79 16C79-2 93-11 108-11C120-11 138-3 145 17C146 19 158 66 164 91L186 181C192 203 198 225 203 248L216 298C231 329 284 420 379 420C424 420 433 383 433 350C433 288 384 160 368 117C359 94 358 82 358 71C358 24 393-11 440-11C534-11 571 135 571 143Z"></path></g></g></g></g>',1),L=[q],P=n("mjx-assistive-mml",{unselectable:"on",display:"inline"},[n("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[n("msub",null,[n("mi",null,"x"),n("mi",null,"n")])])],-1),x=n("p",null,"顺便提一句，看到 Override hashCode() 和 equals()，那么大概率他是要在某个数据表里作为 key 使用了。",-1),I=a(`<li><p>DefaultMQPushConsumerImpl::pullMessage</p><p>这个方法也很长，老样子删减，只看主要逻辑，这里我把 pullMessage 的代码分成了三个部分。 前面控流的部分可以不看，中间 callback 要看一下，核心内容在第三段。</p><p>下面控流这一段可以不看，可全部跳过。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// DefaultMQPushConsumerImpl::pullMessage</span>
<span class="token comment">// get ProcessQueue</span>
<span class="token keyword">final</span> <span class="token class-name">ProcessQueue</span> processQueue <span class="token operator">=</span> pullRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 控流</span>
<span class="token comment">// 本地缓存消息数量 processQueue.getMsgCount &gt; 1000 触发控流</span>
<span class="token comment">// 间隔为 PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL = 50ms</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedMessageCount <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullThresholdForQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token comment">// 控流的处理方式就是前面贴过的 PullMessageService().executePullRequestLater</span>
   <span class="token comment">// 实际上就是把 pullRequest 重新 put 回 pullRequestQueue</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestLater</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">,</span> <span class="token constant">PULL_TIME_DELAY_MILLS_WHEN_FLOW_CONTROL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token comment">// log ...</span>
   <span class="token comment">// 然后直接 return</span>
   <span class="token keyword">return</span><span class="token punctuation">;</span>
 <span class="token punctuation">}</span>

 <span class="token comment">// 本地缓存消息 &gt; 100 Mb 触发控流</span>
 <span class="token comment">// 处理方式同上 代码略</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>cachedMessageSizeInMiB <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullThresholdSizeForQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>

 <span class="token comment">// 并发消费控流</span>
 <span class="token comment">// maxSpan &gt; 2000 处理方式同上</span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>processQueue<span class="token punctuation">.</span><span class="token function">getMaxSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumeConcurrentlyMaxSpan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>

 <span class="token comment">// 顺序消费</span>
 <span class="token comment">// 不算是控流、不过处理方式一样  </span>
 <span class="token keyword">if</span> <span class="token punctuation">(</span>processQueue<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">// pullRequest.isPreviouslyLocked 默认为 false</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pullRequest<span class="token punctuation">.</span><span class="token function">isPreviouslyLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 首次 pullMessage 会进入这里</span>
        <span class="token keyword">long</span> offset <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1L</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token comment">// 根据默认的初始消费位点（见基础概念-消费位点部分） 计算实际消费位点</span>
          <span class="token comment">// 这个可以自己去看代码，或者看书也行</span>
            offset <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">computePullFromWhereWithException</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestLater</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">,</span> pullTimeDelayMillsWhenException<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to compute pull offset, pullResult: {}&quot;</span><span class="token punctuation">,</span> pullRequest<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// broker 异常 or readFile 异常时会为 true，也就是 offset 为 -1</span>
        <span class="token comment">// offset 如果正常会后面会设置为 pullRequest.nextOffset 的值</span>
        <span class="token keyword">boolean</span> brokerBusy <span class="token operator">=</span> offset <span class="token operator">&lt;</span> pullRequest<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;the first time to pull message, so fix offset from broker. pullRequest: {} NewOffset: {} brokerBusy: {}&quot;</span><span class="token punctuation">,</span>
            pullRequest<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> brokerBusy<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>brokerBusy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[NOTIFYME]the first time to pull message, but pull request offset larger than broker consume offset. pullRequest: {} NewOffset: {}&quot;</span><span class="token punctuation">,</span>
                pullRequest<span class="token punctuation">,</span> offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        pullRequest<span class="token punctuation">.</span><span class="token function">setPreviouslyLocked</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// pullTimeDelayMillsWhenException 默认 3000ms</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestLater</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">,</span> pullTimeDelayMillsWhenException<span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;pull message later because not locked in broker, {}&quot;</span><span class="token punctuation">,</span> pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后来看第二部分，一个老长的 callback，主要看 onSuccess 方法，它是给 consumer 发起异步请求成功时用的。主要功能就是把拉回来的数据解码为 msgList 然后存入 msgTreeMap 以便消费，最后调用 consumeMessageService.submitConsumeRequest 提交复制消费的执行器执行。</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// DefaultMQPushConsumerImpl::pullMessage  </span>

<span class="token class-name">PullCallback</span> pullCallback <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PullCallback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onSuccess</span><span class="token punctuation">(</span><span class="token class-name">PullResult</span> pullResult<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 对从 broker 上拉回来的消息进行解码过滤等处理。</span>
    pullResult <span class="token operator">=</span> <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>pullAPIWrapper<span class="token punctuation">.</span><span class="token function">processPullResult</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pullResult<span class="token punctuation">,</span>
        subscriptionData<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">switch</span> <span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getPullStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">case</span> <span class="token constant">FOUND</span><span class="token operator">:</span> <span class="token comment">// FOUND 就是代表 从 Broker 拉回了新消息</span>
            <span class="token keyword">long</span> prevRequestOffset <span class="token operator">=</span> pullRequest<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 状态信息的处理 略 ...</span>

            <span class="token keyword">long</span> firstMsgOffset <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">;</span>
            <span class="token comment">// MsgFoundList 为空，立刻再提交一个 pullRequest 到队列中</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// 拉回的第一条消息的 offset</span>
                firstMsgOffset <span class="token operator">=</span> pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getQueueOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 状态处理，略</span>

                <span class="token comment">// 就是存入 msgTreeMap ，顺便同步维护 ProcessQueue 的属性</span>
                <span class="token comment">// 只要 msgTreeMap 不为空，且 ProcessQueue 不处于 消费中的状态，就返回 true</span>
                <span class="token comment">// 其他情况则返回 false</span>
                <span class="token keyword">boolean</span> dispatchToConsume <span class="token operator">=</span> processQueue<span class="token punctuation">.</span><span class="token function">putMessage</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 然后就来到了 consumeMessageService.submitConsumeRequest</span>
                <span class="token comment">// 也就是前文讲的 创建 ConsumeRequest 并提交给 consumeExecutor 去执行。</span>
                <span class="token comment">// 这方法有两种实现，顺序消费/并发消费</span>
                <span class="token comment">// dispatchToConsume 参数仅作用于顺序消费，如果是 false 则不会执行</span>
                <span class="token comment">// 并发消费无所谓顺序，所以 dispatchToConsume 参数就没啥用</span>
                <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>consumeMessageService<span class="token punctuation">.</span><span class="token function">submitConsumeRequest</span><span class="token punctuation">(</span>
                    pullResult<span class="token punctuation">.</span><span class="token function">getMsgFoundList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    processQueue<span class="token punctuation">,</span>
                    pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    dispatchToConsume<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// 这个 PullInterval 拉取间隔默认是0 ，如果大于0了自然就是等会儿再去拉取。</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestLater</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">,</span>
                        <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullInterval</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token comment">// PullInterval == 0 就立即拉取</span>
                    <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> prevRequestOffset
                <span class="token operator">||</span> firstMsgOffset <span class="token operator">&lt;</span> prevRequestOffset<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;[BUG] pull message result maybe data wrong, nextBeginOffset: {} firstMsgOffset: {} prevRequestOffset: {}&quot;</span><span class="token punctuation">,</span>
                    pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    firstMsgOffset<span class="token punctuation">,</span>
                    prevRequestOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">NO_NEW_MSG</span><span class="token operator">:</span> <span class="token comment">// 没有新消息</span>
        <span class="token keyword">case</span> <span class="token constant">NO_MATCHED_MSG</span><span class="token operator">:</span> <span class="token comment">// 没有匹配的消息</span>
            pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 更新 offset,本地 or local 两种方式</span>
            <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">correctTagsOffset</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestImmediately</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token constant">OFFSET_ILLEGAL</span><span class="token operator">:</span> <span class="token comment">// 偏移量非法</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;the pull request offset illegal, {} {}&quot;</span><span class="token punctuation">,</span>
                pullRequest<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pullResult<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pullRequest<span class="token punctuation">.</span><span class="token function">setNextOffset</span><span class="token punctuation">(</span>pullResult<span class="token punctuation">.</span><span class="token function">getNextBeginOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pullRequest<span class="token punctuation">.</span><span class="token function">getProcessQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDropped</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executeTaskLater</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
              <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token comment">// 重新计算并更新偏移量，移除当前 processQueue</span>
                    <span class="token comment">// 这部分就不展开了</span>
                    <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore<span class="token punctuation">.</span><span class="token function">updateOffset</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>pullRequest<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore<span class="token punctuation">.</span><span class="token function">persist</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    <span class="token class-name">DefaultMQPushConsumerImpl</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">removeProcessQueue</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;fix the pull request offset, {}&quot;</span><span class="token punctuation">,</span> pullRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;executeTaskLater Exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token annotation punctuation">@Override</span>
  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最后是第三部分，对 broker 发起拉取消息请求：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// 3rd part</span>
  <span class="token keyword">boolean</span> commitOffsetEnable <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">long</span> commitOffsetValue <span class="token operator">=</span> <span class="token number">0L</span><span class="token punctuation">;</span>
  <span class="token comment">// 读取消费位点，分顺序/集群两种实现，不过集群也是从本地内存里读</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MessageModel</span><span class="token punctuation">.</span><span class="token constant">CLUSTERING</span> <span class="token operator">==</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      commitOffsetValue <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>offsetStore<span class="token punctuation">.</span><span class="token function">readOffset</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ReadOffsetType</span><span class="token punctuation">.</span><span class="token constant">READ_FROM_MEMORY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>commitOffsetValue <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          commitOffsetEnable <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token class-name">String</span> subExpression <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">boolean</span> classFilter <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token comment">// 从 rebalanceImpl 中根据 topic 拿到订阅数据</span>
  <span class="token class-name">SubscriptionData</span> sd <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">getSubscriptionInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>sd <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// isPostSubscriptionWhenPull 是否每次 pull 的时候都更新订阅关系 ，默认 false</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">isPostSubscriptionWhenPull</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sd<span class="token punctuation">.</span><span class="token function">isClassFilterMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          subExpression <span class="token operator">=</span> sd<span class="token punctuation">.</span><span class="token function">getSubString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      classFilter <span class="token operator">=</span> sd<span class="token punctuation">.</span><span class="token function">isClassFilterMode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> sysFlag <span class="token operator">=</span> <span class="token class-name">PullSysFlag</span><span class="token punctuation">.</span><span class="token function">buildSysFlag</span><span class="token punctuation">(</span>
      commitOffsetEnable<span class="token punctuation">,</span> <span class="token comment">// commitOffset</span>
      <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// suspend</span>
      subExpression <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token comment">// subscription</span>
      classFilter <span class="token comment">// class filter</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// 最后 netty client 发起拉消息的请求，这就不展开了</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>pullAPIWrapper<span class="token punctuation">.</span><span class="token function">pullKernelImpl</span><span class="token punctuation">(</span>
          pullRequest<span class="token punctuation">.</span><span class="token function">getMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          subExpression<span class="token punctuation">,</span>
          subscriptionData<span class="token punctuation">.</span><span class="token function">getExpressionType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          subscriptionData<span class="token punctuation">.</span><span class="token function">getSubVersion</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          pullRequest<span class="token punctuation">.</span><span class="token function">getNextOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getPullBatchSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          sysFlag<span class="token punctuation">,</span>
          commitOffsetValue<span class="token punctuation">,</span>
          <span class="token constant">BROKER_SUSPEND_MAX_TIME_MILLIS</span><span class="token punctuation">,</span>
          <span class="token constant">CONSUMER_TIMEOUT_MILLIS_WHEN_SUSPEND</span><span class="token punctuation">,</span>
          <span class="token class-name">CommunicationMode</span><span class="token punctuation">.</span><span class="token constant">ASYNC</span><span class="token punctuation">,</span>
          pullCallback
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;pullKernelImpl exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">executePullRequestLater</span><span class="token punctuation">(</span>pullRequest<span class="token punctuation">,</span> pullTimeDelayMillsWhenException<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li>`,1),T=a(`<h3 id="负载均衡" tabindex="-1"><a class="header-anchor" href="#负载均衡"><span>负载均衡</span></a></h3><p>rebalance 这一层从理论模型角度看是加在消费行为之前的，主要针对集群消费模式。</p><p>实际实现方式是，负载均衡器每隔 20s 对远程 Queue 上锁，然后执行 doRebalance，最后释放锁。</p><p>换句话说就是消费组内的每个 consumer 都只管从 processQueue 中取出消息进行消费，而负载均衡器则利用分配策略为 consumer 分配他应该消费哪些消息。</p><ul><li>基本组成</li></ul><p><code>RebalanceImpl</code> 是个抽象类，有三个子类，<code>RebalanceLitePullImpl</code>，<code>RebalancePullImpl</code>，<code>RebalancePushImpl</code>。 很明显就是对应三种 consumer 实现类。 以 Push 模式为例，负载均衡器内部维护如下三个数据表：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">,</span> <span class="token class-name">ProcessQueue</span><span class="token punctuation">&gt;</span></span> processQueueTable <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">,</span> <span class="token class-name">ProcessQueue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">64</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span><span class="token comment">/* topic */</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span><span class="token operator">&gt;</span> topicSubscribeInfoTable <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">protected</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token operator">&lt;</span><span class="token class-name">String</span> <span class="token comment">/* topic */</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token operator">&gt;</span> subscriptionInner <span class="token operator">=</span>
    <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>四条属性，在 consumer 启动阶段初始化（实际上 subscriptionInner 也会初始化）：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setConsumerGroup</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getConsumerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setMessageModel</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getMessageModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setAllocateMessageQueueStrategy</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>defaultMQPushConsumer<span class="token punctuation">.</span><span class="token function">getAllocateMessageQueueStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>rebalanceImpl<span class="token punctuation">.</span><span class="token function">setmQClientFactory</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>构造方法：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token class-name">RebalancePushImpl</span><span class="token punctuation">(</span><span class="token class-name">DefaultMQPushConsumerImpl</span> defaultMQPushConsumerImpl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> defaultMQPushConsumerImpl<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>负载均衡的实现和 consumer 的实现要对应。</p><p>延迟解锁的值默认为 20s，也就是一个负载均衡器远程上锁的周期：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token constant">UNLOCK_DELAY_TIME_MILLS</span> <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">parseLong</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;rocketmq.client.unlockDelayTimeMills&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;20000&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>负责执行负载均衡任务的是 <code>RebalanceService</code>。</p><p>它的工作就是 20s 执行一次负载均衡：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// RebalanceService::run</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isStopped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">waitForRunning</span><span class="token punctuation">(</span>waitInterval<span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token keyword">this</span><span class="token punctuation">.</span>mqClientFactory<span class="token punctuation">.</span><span class="token function">doRebalance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>负载均衡操作 RebalanceImpl::doRebalance</li></ul><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token comment">// RebalanceImpl::doRebalance  </span>

<span class="token comment">// isOder 在 Pull 模式为 false，Push 模式根据 consumer.isConsumeOrderly 判断</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doRebalance</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">boolean</span> isOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token punctuation">&gt;</span></span> subTable <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSubscriptionInner</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>subTable <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">SubscriptionData</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> subTable<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> topic <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// this one</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">rebalanceByTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> isOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>topic<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token constant">RETRY_GROUP_TOPIC_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;rebalanceByTopic Exception&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 从 processQueueTable 中剔除订阅关系错误的消息</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">truncateMessageQueueNotMyTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>然后来看 <code>RebalanceImpl::rebalanceByTopic</code>：</p><div class="language-java line-numbers-mode" data-ext="java" data-title="java"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">rebalanceByTopic</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">switch</span> <span class="token punctuation">(</span>messageModel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">case</span> <span class="token constant">BROADCASTING</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 广播模式跟负载均衡这个概念其实没啥关系</span>
              <span class="token comment">// 略 ...</span>
             <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">case</span> <span class="token constant">CLUSTERING</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token comment">// 主要看集群模式  </span>
           <span class="token comment">// topic 下的 MessageQueue 集合</span>
             <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqSet <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topicSubscribeInfoTable<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment">// cidAll 就是 topic 对应的 消费组下的所有 consumer 的 id 列表</span>
             <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cidAll <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">findConsumerIdList</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> consumerGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> mqSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>topic<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token class-name">MixAll</span><span class="token punctuation">.</span><span class="token constant">RETRY_GROUP_TOPIC_PREFIX</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;doRebalance, {}, but the topic[{}] not exist.&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> cidAll<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;doRebalance, {} {}, get consumer id list failed&quot;</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span>

             <span class="token keyword">if</span> <span class="token punctuation">(</span>mqSet <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> cidAll <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> mqAll <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 mqAll<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>mqSet<span class="token punctuation">)</span><span class="token punctuation">;</span>

                 <span class="token comment">// 排序，保证每个 consumer 上都是一致的。</span>
                 <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>mqAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>

                 <span class="token class-name">AllocateMessageQueueStrategy</span> strategy <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>allocateMessageQueueStrategy<span class="token punctuation">;</span>

                 <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> allocateResult <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
                 <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 根据不同策略来分配</span>
                     allocateResult <span class="token operator">=</span> strategy<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>
                         <span class="token keyword">this</span><span class="token punctuation">.</span>consumerGroup<span class="token punctuation">,</span>
                         <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         mqAll<span class="token punctuation">,</span>
                         cidAll<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;AllocateMessageQueueStrategy.allocate Exception. allocateMessageQueueStrategyName={}&quot;</span><span class="token punctuation">,</span> strategy<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">return</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>

                 <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span> allocateResultSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageQueue</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>allocateResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     allocateResultSet<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>allocateResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
                 <span class="token comment">// 遍历 processQueueTable，根据 allocateResultSet 剔除无效队列，添加新队列失败时，重新计算消费位点并重拉消息。</span>
                 <span class="token comment">// 只要对 processQueueTable 进行修改就会返回 true ，nothing touched return false</span>
                 <span class="token comment">// 通常是消费组内的 consumer 数量发生变化，然后负载均衡器就要给 consumer 重新计算它现在要负载消费哪个队列</span>
                 <span class="token keyword">boolean</span> changed <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateProcessQueueTableInRebalance</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> allocateResultSet<span class="token punctuation">,</span> isOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token keyword">if</span> <span class="token punctuation">(</span>changed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span>
                         <span class="token string">&quot;rebalanced result changed. allocateMessageQueueStrategyName={}, group={}, topic={}, clientId={}, mqAllSize={}, cidAllSize={}, rebalanceResultSize={}, rebalanceResultSet={}&quot;</span><span class="token punctuation">,</span>
                         strategy<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> consumerGroup<span class="token punctuation">,</span> topic<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>mQClientFactory<span class="token punctuation">.</span><span class="token function">getClientId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> mqSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cidAll<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                         allocateResultSet<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> allocateResultSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                     <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">messageQueueChanged</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> mqSet<span class="token punctuation">,</span> allocateResultSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
                 <span class="token punctuation">}</span>
             <span class="token punctuation">}</span>
             <span class="token keyword">break</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token keyword">default</span><span class="token operator">:</span>
             <span class="token keyword">break</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到广播模式就是直接执行 <code>updateProcessQueueTableInRebalance</code>，集群模式则是先执行 rebalance，然后再执行 <code>updateProcessQueueTableInRebalance</code>。 说白了广播模式不存在负载均衡这个概念。</p><ul><li><p>AllocateMessageQueueStrategy 负载均衡策略</p><p>目前一共六种负载均衡策略，默认的是 <code>AllocateMessageQueueAveragely</code>，这里就不罗列了，有兴趣可以自己去看。顺便自行探索为什么文档和最佳实践都建议消费者数量要比队列数量少。</p></li><li><p>总结</p><p>可以看出，rebalance 是一个集群模式下的，基于队列和消费者数量的负载均衡。 它把队列和消费者进行了一对一映射，然后每个消费者按 pullMsg --&gt; 提交消费位点 --&gt; 持久化消费位点的流程处理消息，pullMsg 时不提交消费状态。 为了避免消息被多个消费者重复消费，每个队列仅被一个消费者消费。</p><p>并且要注意，由于 rebalance 是单独一个线程每 20s 进行一次分配，当队列数、消费者数发生变化时，重复消费是有可能发生的。</p><p>注意这里都是 4.x 版本，5.x 版本负载均衡这块有重构，而且提供了消息粒度的负载均衡。</p></li></ul><h3 id="消息确认" tabindex="-1"><a class="header-anchor" href="#消息确认"><span>消息确认</span></a></h3><p>无论是消费成功还是失败，亦或者其他情况，consumer 都会有“消费结果”，根据消费结果状态的不同，consumer 会进行不一样的处理（见 <code>consumer.processConsumeResult()</code>），比如 <code>RECONSUME_LATER</code> 就会把消息发回 broker 从而延迟消费。这个流程叫消息确认，或 SendMsgBack，或 ack 消息。</p><p>这部分代码就不展开分析了，本质就是 netty client 给 netty server 发请求，具体来说就是 <code>MQClientAPIImpl::consumerSendMessageBack</code> 方法，请求码为 <code>RequestCode.CONSUMER_SEND_MSG_BACK</code>，然后按照 rocketmq 自定义的请求协议封装好 requestHeader、body，encode，发送请求。 然后发送请求依然是有同步异步两种方式，不再赘述。</p><p>细节部分如果有兴趣，一方面你可以去查书 (《RocketMQ 技术内幕》)，另一方面你可以去看内部协议的实现，个人建议两种方式结合，毕竟缺乏注释和细节文档的代码有个参考书还是好的。</p><h2 id="总结" tabindex="-1"><a class="header-anchor" href="#总结"><span>总结</span></a></h2><p>消息消费就到这里结束啦，已经太长了，又不是写书。没有特意讲解 pull 模式和并发消费的流程，不过大同小异。比如 Pull 模式的 consumer 实现，哪怕你不去看代码现在也应该能推测出来，它跟 <code>DefaultMQPushConsumer</code> 的区别就是它是自己主动去拉取消息，换句话说它不需要 <code>PullMessageService</code>，其他几乎都一样。<code>ConsumeMessageConcurrentlyService</code> 也是同理，它不需要保证顺序，所以直接消费就可以了，不需要像顺序消费一样从 consumingMsgOrderlyTreeMap 里一个个取，一个个提交。</p><p>接下来我们会回到 rocketmq-store，来看看 RocketMQ 的高可用也就是 HA 的实现。</p>`,30);function O(_,E){const p=l("ExternalLinkIcon");return e(),t("div",null,[i,k,r,d,n("p",null,[s("这部分可以直接看官方文档，有图，"),n("a",m,[s("官方 4.x"),o(p)]),s("。")]),v,n("p",null,[s("不想画图，详见"),n("a",b,[s("官方文档-4.x-订阅关系一致"),o(p)]),s("。")]),g,n("ul",null,[C,n("li",null,[f,n("mjx-container",h,[(e(),t("svg",y,M)),R]),n("p",null,[s("n 是迭代次数，"),n("mjx-container",S,[(e(),t("svg",Q,L)),P]),s(" 是变量，需要计算几次就迭代几次")]),x]),I]),T])}const N=c(u,[["render",O],["__file","consume-msg.html.vue"]]),A=JSON.parse('{"path":"/docs/message-queue/rocketmq/consume-msg.html","title":"RocketMQ 源码分析-消费消息","lang":"zh-CN","frontmatter":{"title":"RocketMQ 源码分析-消费消息","order":6,"description":"RocketMQ 源码分析-消费消息 RocketMQ 面向的场景很多，不同场景对消息队列的要求是不一样的，尤其是在消费环节。 还是老样子，先介绍一些它的名词/基础概念，然后介绍消费相关的分类，最后跟着源码去看。 基础概念 这部分可以直接看官方文档，有图，官方 4.x。 消费模式 注 注意跟后面的 消息模式 MessageModel 进行区分。 推/拉...","head":[["meta",{"property":"og:url","content":"https://lament-z.com/docs/message-queue/rocketmq/consume-msg.html"}],["meta",{"property":"og:site_name","content":"鲸鱼气球"}],["meta",{"property":"og:title","content":"RocketMQ 源码分析-消费消息"}],["meta",{"property":"og:description","content":"RocketMQ 源码分析-消费消息 RocketMQ 面向的场景很多，不同场景对消息队列的要求是不一样的，尤其是在消费环节。 还是老样子，先介绍一些它的名词/基础概念，然后介绍消费相关的分类，最后跟着源码去看。 基础概念 这部分可以直接看官方文档，有图，官方 4.x。 消费模式 注 注意跟后面的 消息模式 MessageModel 进行区分。 推/拉..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-03-05T07:00:53.000Z"}],["meta",{"property":"article:author","content":"lament-z"}],["meta",{"property":"article:modified_time","content":"2024-03-05T07:00:53.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"RocketMQ 源码分析-消费消息\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2024-03-05T07:00:53.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"lament-z\\",\\"url\\":\\"https://lament-z.com\\"}]}"]]},"headers":[{"level":2,"title":"基础概念","slug":"基础概念","link":"#基础概念","children":[{"level":3,"title":"消费模式","slug":"消费模式","link":"#消费模式","children":[]},{"level":3,"title":"消费者 Consumer","slug":"消费者-consumer","link":"#消费者-consumer","children":[]},{"level":3,"title":"消费组 ConsumerGroup","slug":"消费组-consumergroup","link":"#消费组-consumergroup","children":[]},{"level":3,"title":"MessageMode 消息模式","slug":"messagemode-消息模式","link":"#messagemode-消息模式","children":[]},{"level":3,"title":"集群模式-负载均衡","slug":"集群模式-负载均衡","link":"#集群模式-负载均衡","children":[]},{"level":3,"title":"消费位点 (consuming point)","slug":"消费位点-consuming-point","link":"#消费位点-consuming-point","children":[]},{"level":3,"title":"订阅关系 && 订阅关系一致","slug":"订阅关系-订阅关系一致","link":"#订阅关系-订阅关系一致","children":[]}]},{"level":2,"title":"源码分析","slug":"源码分析","link":"#源码分析","children":[{"level":3,"title":"消费端的实现类","slug":"消费端的实现类","link":"#消费端的实现类","children":[]},{"level":3,"title":"Consumer 启动流程","slug":"consumer-启动流程","link":"#consumer-启动流程","children":[]},{"level":3,"title":"ConsumeMessageService","slug":"consumemessageservice","link":"#consumemessageservice","children":[]},{"level":3,"title":"PullMessageService","slug":"pullmessageservice","link":"#pullmessageservice","children":[]},{"level":3,"title":"负载均衡","slug":"负载均衡","link":"#负载均衡","children":[]},{"level":3,"title":"消息确认","slug":"消息确认","link":"#消息确认","children":[]}]},{"level":2,"title":"总结","slug":"总结","link":"#总结","children":[]}],"git":{"createdTime":1709305730000,"updatedTime":1709622053000,"contributors":[{"name":"Lament","email":"lament.wy@gmail.com","commits":2}]},"readingTime":{"minutes":21.6,"words":6481},"filePathRelative":"docs/message-queue/rocketmq/consume-msg.md","localizedDate":"2024年3月1日","autoDesc":true,"excerpt":"\\n<p>RocketMQ 面向的场景很多，不同场景对消息队列的要求是不一样的，尤其是在消费环节。</p>\\n<p>还是老样子，先介绍一些它的名词/基础概念，然后介绍消费相关的分类，最后跟着源码去看。</p>\\n<h2>基础概念</h2>\\n<p>这部分可以直接看官方文档，有图，<a href=\\"https://rocketmq.apache.org/zh/docs/4.x/consumer/01concept2\\" target=\\"_blank\\" rel=\\"noopener noreferrer\\">官方 4.x</a>。</p>\\n<h3>消费模式</h3>\\n<div class=\\"hint-container note\\">\\n<p class=\\"hint-container-title\\">注</p>\\n<p>注意跟后面的 消息模式 MessageModel 进行区分。</p>\\n</div>"}');export{N as comp,A as data};
